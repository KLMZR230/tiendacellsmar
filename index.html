<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tienda Completa</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --color-primary: #007bff;
            --color-primary-dark: #0056b3;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --color-grey: #6c757d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--color-light);
            color: var(--color-dark);
        }
        .hidden { display: none !important; }

        /* --- Estilos de Navegación --- */
        nav {
            background-color: #fff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        nav h1 { color: var(--color-primary); margin: 0; font-size: 1.5rem; }
        nav a {
            text-decoration: none;
            color: var(--color-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }
        nav a:hover { background-color: #f1f1f1; }

        /* --- Estilos Generales de Contenedor --- */
        main { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        section { padding: 1rem; }

        /* --- 1. Estilos de la TIENDA --- */
        #loading-message { font-size: 1.2rem; text-align: center; padding: 2rem; }
        #product-grid {
            display: grid;
            /* MODIFICADO: cuadros más pequeños (200px) */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .product-card {
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease;
        }
        .product-card:hover { transform: translateY(-5px); }
        .product-image-container { width: 100%; aspect-ratio: 1 / 1; }
        .product-image { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; }
        .product-name { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .product-price { font-size: 1.15rem; color: var(--color-primary); font-weight: 700; margin-bottom: 1rem; }
        .cart-btn {
            padding: 0.75rem; background-color: var(--color-primary); color: white;
            border: none; border-radius: var(--border-radius); cursor: pointer;
            font-size: 1rem; font-weight: 600; text-align: center;
            transition: background-color 0.2s; margin-top: auto;
        }
        .cart-btn:hover { background-color: #0056b3; }

        /* --- 2. Estilos de LOGIN y ADMIN (Formularios) --- */
        .form-container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 2.5rem;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--color-primary);
        }
        .form-container h2 { text-align: center; margin-bottom: 2rem; }
        form { display: grid; gap: 1.25rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 0.5rem; }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%; padding: 0.75rem; border: 1px solid #ccc;
            border-radius: var(--border-radius); font-size: 1rem;
        }
        .file-label {
            display: inline-block; padding: 0.75rem 1rem; background-color: #fff;
            border: 1px solid var(--color-grey); border-radius: var(--border-radius);
            cursor: pointer; transition: background-color 0.2s; text-align: center;
        }
        .file-label:hover { background-color: #f1f1f1; }
        #file-name { font-style: italic; color: var(--color-grey); margin-top: 0.5rem; text-align: center; }
        
        button[type="submit"] {
            padding: 0.85rem; background-color: var(--color-primary); color: white;
            border: none; border-radius: var(--border-radius); cursor: pointer;
            font-size: 1rem; font-weight: 600; display: flex;
            justify-content: center; align-items: center; gap: 0.5rem;
        }
        button[type="submit"]:hover { background-color: var(--color-primary-dark); }
        button[type="submit"]:disabled { background-color: var(--color-grey); cursor: not-allowed; }
        
        #logout-btn {
            width: 100%; padding: 0.75rem; background-color: var(--color-danger); color: white;
            border: none; border-radius: var(--border-radius); cursor: pointer;
            font-size: 1rem; font-weight: 600; margin-top: 1rem;
        }

        /* Indicador de Carga (Spinner) */
        .loader {
            width: 18px; height: 18px; border: 2px solid #FFF;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mensajes de estado */
        .status-message {
            text-align: center; font-weight: 600; margin-top: 1.5rem;
            padding: 0.75rem; border-radius: var(--border-radius);
        }
        .success { background-color: #e6f7ec; color: var(--color-success); border: 1px solid var(--color-success); }
        .error { background-color: #fdecea; color: var(--color-danger); border: 1px solid var(--color-danger); }
        
        footer { text-align: center; padding: 2rem; margin-top: 2rem; color: #777; }
        
        /* --- Estilos del Modal de Pago --- */
        #payment-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: none; /* Oculto por defecto */
        }
        
        #payment-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 101;
            width: 90%;
            max-width: 450px;
            display: none; /* Oculto por defecto */
        }
        
        /* Clase para mostrar el modal */
        #payment-overlay.visible,
        #payment-modal.visible {
            display: block;
        }

        #payment-modal h2 { text-align: center; margin-bottom: 1rem; }
        #payment-modal p { text-align: center; margin-bottom: 2rem; font-size: 1.1rem; }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2.5rem;
            color: #aaa;
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
        }
        
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .payment-btn {
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .payment-btn:hover {
            background-color: #f1f1f1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .payment-btn .emoji { font-size: 1.5rem; }
    </style>
</head>
<body>

    <nav>
        <h1><a href="#shop" style="text-decoration:none; color:inherit;">Mi Tienda</a></h1>
        <div>
            <a href="#shop">Tienda</a>
            <a href="#admin">Admin</a>
        </div>
    </nav>

    <main>

        <section id="shop-section">
            <div id="product-grid">
                </div>
            <p id="loading-message">Cargando productos...</p>
        </section>

        <section id="login-section" class="hidden">
            <div class="form-container">
                <h2>Admin Login</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" id="login-btn">
                        <span id="login-btn-text">Iniciar Sesión</span>
                    </button>
                </form>
                <div id="login-status" class="status-message"></div>
            </div>
        </section>

        <section id="admin-section" class="hidden">
            <div class="form-container">
                <h2>Cargar Nuevo Producto</h2>
                <form id="product-form">
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto:</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Precio:</label>
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-image" class="file-label">
                            Haz clic para subir una imagen
                        </label>
                        <input type="file" id="product-image" accept="image/*" class="hidden" required>
                        <div id="file-name">Ningún archivo seleccionado</div>
                    </div>
                    <button type="submit" id="submit-btn">
                        <span id="loader" class="loader hidden"></span>
                        <span id="btn-text">Guardar Producto</span>
                    </button>
                </form>
                <div id="admin-status" class="status-message"></div>
                <button id="logout-btn">Cerrar Sesión</button>
            </div>
        </section>

    </main>
    
    <div id="payment-overlay" class="hidden"></div>
    
    <div id="payment-modal" class="hidden">
        <button id="close-modal-btn" class="close-btn">&times;</button>
        <h2>Seleccionar Método de Pago</h2>
        <p>Estás comprando: <strong id="modal-product-name">Producto</strong></p>
        
        <div class="payment-options">
            <button class="payment-btn" data-method="cod">
                <span class="emoji">🚚</span> Contra Entrega
            </button>
            <button class="payment-btn" data-method="paypal">
                <span class="emoji">🅿️</span> PayPal
            </button>
            <button class="payment-btn" data-method="card">
                <span class="emoji">💳</span> Tarjeta de Crédito/Débito
            </button>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 Cell Smar. Todos los derechos reservados.</p>
    </footer>


    <script>
        // -----------------------------------------------------------------
        // PASO 1: CONFIGURA TUS DATOS DE SUPABASE
        // ¡¡USA TU NUEVA CLAVE API!!
        // -----------------------------------------------------------------
        const SUPABASE_URL = 'https://kbvheywmgxkpigoldhuw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtidmhleXdtZ3hrcGlnb2xkaHV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODYzOTQsImV4cCI6MjA3NjY2MjM5NH0.KNK1dmVI5iAvKcIdLAjjyhzrLun3ZgwQe1LIuBhgZU0'; 
        // -----------------------------------------------------------------

        // Inicializar cliente
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Seleccionar Secciones
        const shopSection = document.getElementById('shop-section');
        const loginSection = document.getElementById('login-section');
        const adminSection = document.getElementById('admin-section');
        const sections = [shopSection, loginSection, adminSection];
        
        // --- Elemento de decodificación (para nombres con comillas) ---
        const decoder = document.createElement('textarea');

        // --- ENRUTADOR (Router) ---
        // Esta función decide qué sección mostrar
        async function handleRouting() {
            const hash = window.location.hash || '#shop'; // Por defecto, muestra la tienda
            
            // Ocultar todas las secciones
            sections.forEach(s => s.classList.add('hidden'));

            if (hash === '#shop') {
                shopSection.classList.remove('hidden');
                loadProducts(); // Cargar productos al ver la tienda
            } 
            else if (hash === '#login') {
                loginSection.classList.remove('hidden');
            }
            else if (hash === '#admin') {
                // --- ¡EL GUARDIA DE SEGURIDAD! ---
                const { data: { session } } = await _supabase.auth.getSession();
                if (session) {
                    // Usuario logueado: mostrar admin
                    adminSection.classList.remove('hidden');
                } else {
                    // Usuario NO logueado: redirigir a login
                    window.location.hash = '#login';
                }
            }
        }

        // --- LÓGICA DE LA TIENDA ---
        const grid = document.getElementById('product-grid');
        const loadingMessage = document.getElementById('loading-message');
        let productsLoaded = false; // Evitar recargar productos innecesariamente

        // --- CORREGIDO: Función para escapar HTML para atributos ---
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/&/g, '&amp;');
        }

        async function loadProducts() {
            if (productsLoaded) return; // Si ya están cargados, no hacer nada

            loadingMessage.textContent = 'Cargando productos...';
            loadingMessage.style.display = 'block';
            grid.innerHTML = ''; // Limpiar la cuadrícula

            try {
                const { data, error } = await _supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    loadingMessage.textContent = 'Aún no hay productos en la tienda.';
                    return;
                }

                loadingMessage.style.display = 'none';

                data.forEach(product => {
                    const formattedPrice = parseFloat(product.price).toFixed(2);
                    
                    // --- CORREGIDO: Escapar nombre para data-name y alt ---
                    const safeName = escapeHTML(product.name);
                    
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-image-container">
                            <img src="${product.image_url}" alt="${safeName}" class="product-image">
                        </div>
                        <div class="product-info">
                            <h2 class="product-name">${product.name}</h2>
                            <p class="product-price">$${formattedPrice}</p>
                            <button class="cart-btn" data-id="${product.id}" data-name="${safeName}">Añadir al Carrito</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                productsLoaded = true; // Marcar como cargados

            } catch (error) {
                console.error('Error cargando productos:', error.message);
                loadingMessage.textContent = `Error al cargar la tienda: ${error.message}`;
            }
        }
        
        // --- LÓGICA DEL MODAL DE PAGO ---
        const paymentOverlay = document.getElementById('payment-overlay');
        const paymentModal = document.getElementById('payment-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalProductName = document.getElementById('modal-product-name');
        const paymentOptions = document.querySelector('.payment-options');

        function openModal(name, id) {
            // --- CORREGIDO: Decodificar el nombre para mostrarlo ---
            decoder.innerHTML = name;
            modalProductName.textContent = decoder.value;
            
            paymentModal.dataset.productId = id; // Guarda el ID en el modal
            paymentOverlay.classList.add('visible');
            paymentModal.classList.add('visible');
        }

        function closeModal() {
            paymentOverlay.classList.remove('visible');
            paymentModal.classList.remove('visible');
        }

        closeModalBtn.addEventListener('click', closeModal);
        paymentOverlay.addEventListener('click', closeModal); // Cierra al hacer clic afuera

        paymentOptions.addEventListener('click', (e) => {
            const button = e.target.closest('.payment-btn');
            if (!button) return; // No se hizo clic en un botón

            const method = button.dataset.method;
            const productId = paymentModal.dataset.productId;
            const productName = modalProductName.textContent;

            // Aquí es donde procesarías el pago
            alert(`Has seleccionado: ${button.textContent.trim()}\nPara el producto: ${productName}`);
            
            // TODO:
            // if (method === 'paypal') { /* redirigir a paypal */ }
            // if (method === 'card') { /* abrir modal de Stripe */ }
            // if (method === 'cod') { /* enviar a pág de gracias */ }

            closeModal();
        });
        
        // --- CORRECCIÓN FINAL: Listener de clic en 'document' ---
        // Esto es más robusto y siempre encontrará el botón.
        document.addEventListener('click', (e) => {
            const cartButton = e.target.closest('.cart-btn');
            
            // Salir si el clic no fue en un botón de carrito O si el botón no está dentro de la tienda
            if (!cartButton || !shopSection.contains(cartButton)) {
                return;
            }
            
            // Si llegamos aquí, fue un clic válido
            const name = cartButton.dataset.name;
            const id = cartButton.dataset.id;
            openModal(name, id); // Abre el modal con los datos
        });
        // --- FIN DE LA CORRECCIÓN ---
        
        // --- LÓGICA DE AUTENTICACIÓN (Login/Logout) ---
        const loginForm = document.getElementById('login-form');
        const loginStatus = document.getElementById('login-status');
        const logoutBtn = document.getElementById('logout-btn');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginStatus.textContent = '';
            loginStatus.className = 'status-message';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                window.location.hash = '#admin'; // Éxito: redirigir al panel de admin
            } catch (error) {
                loginStatus.textContent = 'Error: Email o contraseña incorrectos.';
                loginStatus.classList.add('error');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await _supabase.auth.signOut();
            window.location.hash = '#login'; // Al cerrar sesión, ir a login
        });

        // --- LÓGICA DEL PANEL DE ADMIN ---
        const productForm = document.getElementById('product-form');
        const adminStatus = document.getElementById('admin-status');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader');
        const fileInput = document.getElementById('product-image');
        const fileNameDiv = document.getElementById('file-name');

        fileInput.addEventListener('change', () => {
            fileNameDiv.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Ningún archivo seleccionado';
        });

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            try {
                const name = document.getElementById('product-name').value;
                const price = parseFloat(document.getElementById('product-price').value);
                const imageFile = fileInput.files[0];
                if (!name || !price || !imageFile) throw new Error('Completa todos los campos.');

                const fileName = `${Date.now()}-${imageFile.name}`;
                
                // 1. Subir imagen
                const { error: uploadError } = await _supabase.storage
                    .from('product-images')
                    .upload(fileName, imageFile);
                if (uploadError) throw uploadError;

                // 2. Obtener URL pública
                const { data: urlData } = _supabase.storage.from('product-images').getPublicUrl(fileName);
                const imageUrl = urlData.publicUrl;

                // 3. Guardar en base de datos
                const { error: insertError } = await _supabase
                    .from('products')
                    .insert([{ name, price, image_url: imageUrl }]);
                if (insertError) throw insertError;

                showStatus('¡Producto guardado con éxito!', 'success');
                productForm.reset();
                fileNameDiv.textContent = 'Ningún archivo seleccionado';
                productsLoaded = false; // Forzar recarga de productos en la tienda la próxima vez

            } catch (error) {
                console.error('Error:', error.message);
                showStatus(error.message, 'error');
            } finally {
                setLoading(false);
            }
        });

        // Funciones de ayuda del Admin
        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
            btnText.textContent = isLoading ? 'Guardando...' : 'Guardar Producto';
        }
        function showStatus(message, type) {
            adminStatus.textContent = message;
            adminStatus.className = `status-message ${type}`;
        }

        // --- INICIALIZACIÓN ---
        // Escuchar cambios en el hash (ej. #shop -> #admin)
        window.addEventListener('hashchange', handleRouting);
        // Cargar la ruta inicial cuando la página esté lista
        document.addEventListener('DOMContentLoaded', handleRouting);

    </script>
</body>
</html>
