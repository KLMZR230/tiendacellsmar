<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tienda Cell Smar</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Importar Fuente Moderna (Poppins) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        :root {
            --font-main: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --color-bg: #0F172A; 
            --color-card-bg: #1E293B; 
            --color-text: #F1F5F9; 
            --color-text-muted: #94A3B8; 
            --color-border: #334155; 
            
            --color-primary-start: #38BDF8; 
            --color-primary-end: #EC4899;   
            --gradient-primary: linear-gradient(90deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%);

            --color-success: #22C55E; 
            --color-danger: #F43F5E;  

            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --border-radius: 8px; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main); 
            line-height: 1.5;
            background-color: var(--color-bg);
            color: var(--color-text);
            -webkit-tap-highlight-color: transparent;
        }
        .hidden { display: none !important; }

        /* --- Navegaci√≥n --- */
        nav {
            background-color: var(--color-card-bg);
            padding: 1rem 1.5rem; 
            box-shadow: var(--shadow);
            border-bottom: 3px solid;
            border-image: var(--gradient-primary) 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-branding {
            display: flex;
            align-items: center;
        }

        nav h1 {
            margin: 0;
            font-size: 2.8rem; /* Grande para PC */
            font-weight: 800; 
            letter-spacing: 1px; 
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            line-height: 1.1; 
        }
        
        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        nav a {
            text-decoration: none;
            color: var(--color-text); 
            font-weight: 600;
            padding: 0.4rem 0.6rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        nav a:hover { background-color: var(--color-border); } 

        @media (max-width: 400px) {
            #login-nav-link span, #admin-nav-link span { display: none; }
            nav h1 { font-size: 1.6rem; } 
            nav { padding: 0.8rem 1rem; }
        }

        /* --- Layout Principal --- */
        main { 
            max-width: 1400px;
            margin: 0 auto; 
            padding: 0 0.5rem;
        }
        section { padding: 0.5rem 0; }

        #loading-message { font-size: 1rem; text-align: center; padding: 2rem; color: var(--color-text-muted); }

        .category-title {
            font-size: 1.3rem; 
            font-weight: 700;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text);
            padding-left: 0.5rem;
        }

        /* === GRID DE PRODUCTOS === */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background-color: var(--color-card-bg);
            border-radius: 6px; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%; 
            position: relative;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border-color: var(--color-primary-start);
        }

        .product-image-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            background-color: #fff;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }

        .product-info {
            padding: 0.75rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .product-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 0.25rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.6em;
        }
        
        /* ESTILO NUEVO PARA LA DESCRIPCI√ìN EN LA TARJETA */
        .product-short-desc {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-bottom: 0.4rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.6em;
        }

        .product-price { 
            font-size: 1.1rem;
            color: var(--color-primary-start); 
            font-weight: 700; 
            margin-bottom: 0.5rem;
        }
        
        .buy-btn {
            width: 100%;
            padding: 0.4rem 0.5rem;
            background: var(--gradient-primary); 
            border: none;
            border-radius: 4px; 
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: auto; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2; 
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .buy-btn:hover { opacity: 0.9; }
        
        @media (max-width: 640px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr); 
                gap: 0.5rem;
            }
            .product-card { border-radius: 4px; }
            .product-info { padding: 0.5rem; }
            .product-name { font-size: 0.8rem; }
            .product-price { font-size: 1rem; }
            .buy-btn { font-size: 0.75rem; padding: 0.35rem; }
            nav { padding: 0.8rem 1rem; }
            nav h1 { font-size: 2rem; } /* Grande en m√≥vil */
            nav a { padding: 0.3rem 0.5rem; font-size: 0.8rem; }
        }

        /* --- Formularios --- */
        .form-container, #orders-container, #admin-products-container {
            max-width: 500px;
            margin: 1.5rem auto;
            padding: 1.5rem;
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-top: 4px solid;
            border-image: var(--gradient-primary) 1;
            width: 95%;
        }
        .form-container h2 { text-align: center; margin-bottom: 1.5rem; color: var(--color-text); font-size: 1.5rem; }
        form { display: grid; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 0.4rem; color: var(--color-text); font-size: 0.9rem; }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%; padding: 0.6rem; border: 1px solid var(--color-border);
            border-radius: 6px; font-size: 0.95rem;
            background-color: var(--color-bg); 
            color: var(--color-text);
            transition: border-color 0.2s;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary-start);
        }

        .file-label {
            display: inline-block; padding: 0.6rem 1rem; 
            background-color: var(--color-border); 
            border: 1px solid var(--color-border); border-radius: 6px;
            cursor: pointer; transition: background-color 0.2s; text-align: center;
            color: var(--color-text); font-size: 0.9rem;
        }

        button[type="submit"] {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 6px;
            background: var(--gradient-primary);
            font-weight: 600;
            color: #fff; border: none; cursor: pointer;
        }

        .form-toggle-links { text-align: center; margin-top: 1rem; font-size: 0.85rem; color: var(--color-text-muted); }
        .form-toggle-links a { color: var(--color-primary-start); font-weight: 600; text-decoration: underline; cursor: pointer; }

        #logout-btn {
            width: 100%; padding: 0.75rem; background-color: var(--color-danger); color: #fff;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 1rem; font-weight: 600; margin-top: 1rem;
        }

        .loader {
            width: 18px; height: 18px; border: 2px solid #fff;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-message {
            text-align: center; font-weight: 600; margin-top: 1rem; padding: 0.6rem; border-radius: 6px;
            border-width: 1px; border-style: solid; font-size: 0.9rem;
        }
        .success { background-color: rgba(34, 197, 94, 0.1); color: var(--color-success); border-color: var(--color-success); }
        .error { background-color: rgba(244, 63, 94, 0.1); color: var(--color-danger); border-color: var(--color-danger); }

        #map-container {
            width: 95%; max-width: 1200px; margin: 2rem auto; 
            overflow: hidden; border-radius: var(--border-radius);
            border: 1px solid var(--color-border); box-shadow: var(--shadow);
            background-color: var(--color-card-bg); min-height: 100px; 
        }
        #map-container iframe { width: 100% !important; height: 300px; border: 0; display: block; }
        @media (min-width: 768px) { #map-container iframe { height: 400px; } }

        footer { 
            text-align: center; padding: 2rem 1rem; margin-top: 2rem; 
            color: var(--color-text-muted); border-top: 1px solid var(--color-border); 
            display: flex; flex-direction: column; align-items: center; gap: 0.5rem; font-size: 0.9rem;
        }

        /* --- MODALES --- */
        #cod-overlay, #edit-product-overlay, #details-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            z-index: 100;
        }
        #cod-modal, #edit-product-modal, #details-modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            width: 90%; max-width: 450px;
            display: none;
            color: var(--color-text);
            border-top: 4px solid; 
            border-image: var(--gradient-primary) 1;
            z-index: 101;
            max-height: 90vh;
            overflow-y: auto;
        }

        #cod-overlay.visible, #cod-modal.visible,
        #edit-product-overlay.visible, #edit-product-modal.visible,
        #details-overlay.visible, #details-modal.visible {
            display: block;
        }

        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #aaa; background: none; border: none; cursor: pointer; line-height: 1; }
        
        #details-modal img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            background: #fff;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        #details-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--color-text); }
        #details-price { font-size: 1.5rem; color: var(--color-primary-start); font-weight: 700; margin-bottom: 1rem; }
        #details-description { color: var(--color-text-muted); line-height: 1.6; margin-bottom: 1.5rem; white-space: pre-wrap; }

        /* Contenedores Admin */
        #orders-container, #admin-products-container, .form-container { width: 95%; max-width: 800px; }
        .order-card { padding: 1rem; margin-bottom: 1rem; font-size: 0.9rem; border: 1px solid var(--color-border); border-radius: 6px; background: var(--color-bg); }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        
        #admin-products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 1rem;
        }
        .admin-product-card { background: var(--color-bg); border-radius: 6px; overflow: hidden; border: 1px solid var(--color-border); }
        .admin-product-card img { width: 100%; height: 120px; object-fit: cover; }
        .admin-product-info { padding: 0.5rem; }
        .admin-product-actions { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--color-border); }
        .admin-product-actions button { background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--color-text); font-weight: 600; }
        .btn-edit { color: var(--color-primary-start) !important; border-right: 1px solid var(--color-border) !important; }
        .btn-delete { color: var(--color-danger) !important; }

        .whatsapp-flotante {
            position: fixed; bottom: 20px; right: 20px; z-index: 999; 
        }
        .whatsapp-flotante img {
            width: 50px; height: 50px; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); 
            transition: transform 0.2s ease;
        }
        .whatsapp-flotante:hover img { transform: scale(1.10); }

        #toast-container {
            position: fixed; top: 20px; right: 20px; left: 20px; z-index: 9999;
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: none; 
        }
        @media (max-width: 600px) { #toast-container { align-items: center; left: 0; right: 0; } }

        .toast {
            background-color: var(--color-card-bg); color: var(--color-text); padding: 0.8rem 1rem;
            border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid var(--color-border);
            border-left: 5px solid var(--color-primary-start); display: flex; align-items: center; gap: 10px;
            min-width: 200px; max-width: 90%; opacity: 0; transform: translateY(-20px);
            animation: slideIn 0.3s ease forwards, fadeOut 0.5s ease 2.5s forwards; pointer-events: auto; 
            font-size: 0.9rem; font-weight: 500;
        }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

    </style>
    </head>
<body>

    <nav>
        <div class="nav-branding">
            <h1><a href="#shop" style="text-decoration:none; color:inherit;">Tienda Cell Smar</a></h1>
        </div>
        <div class="nav-links">
            <a href="#shop">Tienda</a>
            <a href="#login" id="login-nav-link"><span>üë§</span> Iniciar</a>
            <a href="#admin" id="admin-nav-link" class="hidden"><span>‚öôÔ∏è</span> Admin</a>
        </div>
    </nav>

    <main>
        <section id="shop-section">
            <div id="shop-categories-container"></div>
            <p id="loading-message">Cargando productos...</p>
        </section>

        <section id="login-section" class="hidden">
            <div class="form-container" id="login-form-container">
                <form id="login-form">
                    <h2>Admin Login</h2>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" id="login-btn">Iniciar Sesi√≥n</button>
                    <div class="form-toggle-links">
                        ¬øNo tienes cuenta? <a id="show-register">Reg√≠strate</a>
                    </div>
                </form>
                <form id="register-form" class="hidden">
                    <h2>Registrarse</h2>
                    <div class="form-group">
                        <label for="register-email">Email:</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Contrase√±a:</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <button type="submit" id="register-btn">Crear Cuenta</button>
                    <div class="form-toggle-links">
                        ¬øYa tienes cuenta? <a id="show-login">Inicia Sesi√≥n</a>
                    </div>
                </form>
                <div id="login-status" class="status-message"></div>
            </div>
        </section>

        <section id="admin-section" class="hidden">
            <div class="form-container">
                <h2>Cargar Nuevo Producto</h2>
                <form id="product-form">
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto:</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-description">Descripci√≥n (Opcional):</label>
                        <textarea id="product-description" placeholder="Detalles del producto..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Precio:</label>
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">Categor√≠a:</label>
                        <select id="product-category" required>
                            <option value="">-- Selecciona Categor√≠a --</option>
                            <option value="Cambios de Pantalla">Cambios de Pantalla</option>
                            <option value="Cables de Carga">Cables de Carga</option>
                            <option value="Cargadores Samsung">Cargadores Samsung</option>
                            <option value="Cargadores de Iphone">Cargadores de Iphone</option>
                            <option value="Bandejas de SIM">Bandejas de SIM</option>
                            <option value="Protectores Fisicos de Iphone">Protectores Fisicos de Iphone</option>
                            <option value="Protectores Fisicos Samsung">Protectores Fisicos Samsung</option>
                            <option value="Chanclas Adidas Originales">Chanclas Adidas Originales</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-image" class="file-label">Haz clic para subir una imagen</label>
                        <input type="file" id="product-image" accept="image/*" class="hidden" required>
                        <div id="file-name">Ning√∫n archivo seleccionado</div>
                    </div>
                    <button type="submit" id="submit-btn">
                        <span id="loader" class="loader hidden"></span>
                        <span id="btn-text">Guardar Producto</span>
                    </button>
                </form>
                <div id="admin-status" class="status-message"></div>
                <button id="logout-btn">Cerrar Sesi√≥n</button>
            </div>

            <div class="form-container" id="logo-upload-form-container">
                <h2>Configuraci√≥n de la Tienda</h2>
                <form id="logo-upload-form">
                    <div class="form-group">
                        <label for="logo-image" class="file-label">Subir/Actualizar Logo</label>
                        <input type="file" id="logo-image" accept="image/*" class="hidden">
                        <div id="logo-file-name">Ning√∫n archivo seleccionado</div>
                    </div>
                    <button type="submit" id="logo-submit-btn">
                        <span id="logo-loader" class="loader hidden"></span>
                        <span id="logo-btn-text">Guardar Logo</span>
                    </button>
                </form>
                <div id="logo-status" class="status-message hidden"></div>
            </div>
            
            <div class="form-container" id="info-form-container">
                <h2>Informaci√≥n P√∫blica</h2>
                <form id="info-form">
                    <div class="form-group">
                        <label for="admin-contact-info">Informaci√≥n de Contacto:</label>
                        <input type="text" id="admin-contact-info" placeholder="Ej: Tel: 555-1234">
                    </div>
                    <div class="form-group">
                        <label for="admin-address-info">Direcci√≥n:</label>
                        <input type="text" id="admin-address-info" placeholder="Ej: Calle Falsa 123">
                    </div>
                    <div class="form-group">
                        <label for="admin-map-src">URL de Google Maps (Embed):</label>
                        <input type="text" id="admin-map-src" placeholder="Pega aqu√≠ solo la URL 'src'">
                    </div>
                    <button type="submit" id="info-submit-btn">
                        <span id="info-loader" class="loader hidden"></span>
                        <span id="info-btn-text">Guardar Informaci√≥n</span>
                    </button>
                </form>
                <div id="info-status" class="status-message hidden"></div>
            </div>

            <div id="orders-container">
                <h2>Pedidos Recibidos</h2>
                <div id="orders-list"></div>
                <p id="loading-orders-message">Cargando pedidos...</p>
            </div>
            <div id="admin-products-container">
                <h2>Gestionar Productos</h2>
                <div id="admin-products-list"></div>
                <p id="loading-admin-products-message">Cargando productos...</p>
                <div id="admin-products-status" class="status-message hidden"></div>
            </div>
        </section>
    </main>

    <div id="details-overlay" class="hidden"></div>
    <div id="details-modal" class="hidden">
        <button id="close-details-btn" class="close-btn">√ó</button>
        <img src="" alt="Detalle" id="details-image">
        <div id="details-title"></div>
        <div id="details-price"></div>
        <div id="details-description"></div>
        <button id="details-buy-btn" class="buy-btn" style="font-size: 1rem; padding: 0.8rem;">Comprar Ahora</button>
    </div>

    <div id="cod-overlay" class="hidden"></div>
    <div id="cod-modal" class="hidden">
        <button id="close-cod-btn" class="close-btn">√ó</button>
        <h2>Finalizar Compra</h2>
        <p style="text-align: center; margin-bottom: 1rem; color: var(--color-text-muted);">Est√°s comprando: <strong id="cod-product-summary" style="color: var(--color-primary-start);"></strong></p>
        <form id="cod-form">
            <div class="form-group">
                <label for="cod-name">Nombre Completo:</label>
                <input type="text" id="cod-name" required>
            </div>
            <div class="form-group">
                <label for="cod-address">Direcci√≥n de Entrega:</label>
                <input type="text" id="cod-address" required>
            </div>
            <div class="form-group">
                <label for="cod-reference">Punto de Referencia (Opcional):</label>
                <input type="text" id="cod-reference">
            </div>
            <div class="form-group">
                <label for="cod-phone">N√∫mero de Tel√©fono:</label>
                <input type="text" id="cod-phone" required>
            </div>
            <button type="submit" id="cod-submit-btn">
                <span id="cod-loader" class="loader hidden"></span>
                <span id="cod-btn-text">Confirmar Pedido</span>
            </button>
        </form>
        <div id="cod-status" class="status-message hidden"></div>
    </div>

    <div id="edit-product-overlay" class="hidden"></div>
    <div id="edit-product-modal" class="hidden">
        <button id="close-edit-modal-btn" class="close-btn">√ó</button>
        <h2>Editar Producto</h2>
        <form id="edit-product-form">
            <input type="hidden" id="edit-product-id">
            <input type="hidden" id="edit-old-image-url">
            <div class="form-group">
                <label for="edit-product-name">Nombre del Producto:</label>
                <input type="text" id="edit-product-name" required>
            </div>
            <div class="form-group">
                <label for="edit-product-description">Descripci√≥n (Opcional):</label>
                <textarea id="edit-product-description" placeholder="Detalles del producto..."></textarea>
            </div>
            <div class="form-group">
                <label for="edit-product-price">Precio:</label>
                <input type="number" id="edit-product-price" step="0.01" min="0" required>
            </div>
             <div class="form-group">
                <label for="edit-product-category">Categor√≠a:</label>
                <select id="edit-product-category" required>
                    <option value="">-- Selecciona Categor√≠a --</option>
                    <option value="Cambios de Pantalla">Cambios de Pantalla</option>
                    <option value="Cables de Carga">Cables de Carga</option>
                    <option value="Cargadores Samsung">Cargadores Samsung</option>
                    <option value="Cargadores de Iphone">Cargadores de Iphone</option>
                    <option value="Bandejas de SIM">Bandejas de SIM</option>
                    <option value="Protectores Fisicos de Iphone">Protectores Fisicos de Iphone</option>
                    <option value="Protectores Fisicos Samsung">Protectores Fisicos Samsung</option>
                    <option value="Chanclas Adidas Originales">Chanclas Adidas Originales</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-product-image" class="file-label">Cambiar imagen (Opcional)</label>
                <input type="file" id="edit-product-image" accept="image/*" class="hidden">
                <div id="edit-file-name">Ning√∫n archivo nuevo</div>
            </div>
            <button type="submit" id="edit-submit-btn">
                <span id="edit-loader" class="loader hidden"></span>
                <span id="edit-btn-text">Guardar Cambios</span>
            </button>
        </form>
        <div id="edit-product-status" class="status-message hidden"></div>
    </div>

    <div id="map-container"></div>

    <div id="toast-container"></div>

    <footer>
        <p id="footer-contact">Cargando contacto...</p>
        <p id="footer-address">Cargando direcci√≥n...</p>
        <p id="footer-copyright">¬© 2025 Cell Smar. Todos los derechos reservados.</p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://kbvheywmgxkpigoldhuw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtidmhleXdtZ3hrcGlnb2xkaHV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODYzOTQsImV4cCI6MjA3NjY2MjM5NH0.KNK1dmVI5iAvKcIdLAjjyhzrLun3ZgwQe1LIuBhgZU0';

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let productsLoaded = false;
        let currentProductToBuy = null;

        const shopSection = document.getElementById('shop-section');
        const loginSection = document.getElementById('login-section');
        const adminSection = document.getElementById('admin-section');
        const sections = [shopSection, loginSection, adminSection];
        const decoder = document.createElement('textarea');

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span class="toast-icon">‚úÖ</span> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        async function handleRouting() {
            const hash = window.location.hash || '#shop';
            sections.forEach(s => s.classList.add('hidden'));

            if (hash === '#shop') {
                shopSection.classList.remove('hidden');
                loadProducts();
            } else if (hash === '#login') {
                loginSection.classList.remove('hidden');
            } else if (hash === '#admin') {
                const { data: { session } } = await _supabase.auth.getSession();
                if (session) {
                    adminSection.classList.remove('hidden');
                    loadOrders();
                    loadAdminProducts();
                } else {
                    window.location.hash = '#login';
                }
            }
        }

        const shopCategoriesContainer = document.getElementById('shop-categories-container');
        const loadingMessage = document.getElementById('loading-message');

        function escapeHTML(str) {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;') 
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        async function loadProducts() {
            if (productsLoaded) return;
            loadingMessage.textContent = 'Cargando productos...';
            loadingMessage.style.display = 'block';
            shopCategoriesContainer.innerHTML = '';

            try {
                const { data, error } = await _supabase.from('products').select('*').order('category').order('created_at', { ascending: false });
                if (error) throw error;
                if (data.length === 0) {
                    loadingMessage.textContent = 'A√∫n no hay productos en la tienda.';
                    return;
                }
                loadingMessage.style.display = 'none';

                const groupedProducts = {};
                data.forEach(product => {
                    const category = product.category || 'Otros';
                    if (!groupedProducts[category]) groupedProducts[category] = [];
                    groupedProducts[category].push(product);
                });

                for (const category in groupedProducts) {
                    const categorySection = document.createElement('div');
                    const categoryTitle = document.createElement('h2');
                    categoryTitle.className = 'category-title';
                    categoryTitle.textContent = category;
                    categorySection.appendChild(categoryTitle);

                    const categoryGrid = document.createElement('div');
                    categoryGrid.className = 'product-grid';

                    groupedProducts[category].forEach(product => {
                        const formattedPrice = parseFloat(product.price).toFixed(2);
                        const safeName = escapeHTML(product.name);
                        
                        // CORRECCI√ìN: Obtener descripci√≥n y crear versi√≥n corta para la tarjeta
                        const rawDescription = product.description || '';
                        const displayDescription = rawDescription ? rawDescription : 'Sin descripci√≥n detallada.';
                        // Cortar texto para la vista previa (max 60 caracteres)
                        const shortDesc = displayDescription.length > 60 ? displayDescription.substring(0, 60) + '...' : displayDescription;
                        const safeShortDesc = escapeHTML(shortDesc);

                        const card = document.createElement('div');
                        card.className = 'product-card';
                        
                        // Guardamos la descripci√≥n completa en el dataset para el Modal
                        card.dataset.id = product.id;
                        card.dataset.name = safeName;
                        card.dataset.price = formattedPrice;
                        card.dataset.imageUrl = product.image_url;
                        card.dataset.description = rawDescription; 

                        card.innerHTML = `
                            <div class="product-image-container">
                                <img src="${product.image_url}" alt="${safeName}" class="product-image"> 
                            </div>
                            <div class="product-info">
                                <h2 class="product-name">${product.name}</h2>
                                <p class="product-short-desc">${safeShortDesc}</p>
                                <p class="product-price">$${formattedPrice}</p>
                                <button class="buy-btn"
                                    data-id="${product.id}"
                                    data-name="${safeName}"
                                    data-price="${formattedPrice}"
                                    data-image-url="${product.image_url}">Comprar Ahora</button>
                            </div>`;
                        categoryGrid.appendChild(card);
                    });

                    categorySection.appendChild(categoryGrid);
                    shopCategoriesContainer.appendChild(categorySection);
                }

                productsLoaded = true;
            } catch (error) {
                console.error('Error cargando productos:', error.message);
                loadingMessage.textContent = `Error al cargar la tienda: ${error.message}`;
            }
        }

        // --- L√ìGICA MODAL DETALLES ---
        const detailsOverlay = document.getElementById('details-overlay');
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsBtn = document.getElementById('close-details-btn');
        const detailsBuyBtn = document.getElementById('details-buy-btn');

        function openDetailsModal(productData) {
            decoder.innerHTML = productData.name;
            const decodedName = decoder.value;
            
            // Descripci√≥n directa del dataset (ya es texto plano)
            const decodedDesc = productData.description;

            document.getElementById('details-image').src = productData.imageUrl;
            document.getElementById('details-title').textContent = decodedName;
            document.getElementById('details-price').textContent = `$${productData.price}`;
            document.getElementById('details-description').textContent = decodedDesc || "Sin descripci√≥n detallada.";

            detailsBuyBtn.onclick = () => {
                closeDetailsModal();
                openCodModal(productData);
            };

            detailsOverlay.classList.remove('hidden'); detailsModal.classList.remove('hidden');
            detailsOverlay.classList.add('visible'); detailsModal.classList.add('visible');
        }

        function closeDetailsModal() {
            detailsOverlay.classList.remove('visible'); detailsModal.classList.remove('visible');
            detailsOverlay.classList.add('hidden'); detailsModal.classList.add('hidden');
        }

        closeDetailsBtn.addEventListener('click', closeDetailsModal);
        detailsOverlay.addEventListener('click', closeDetailsModal);


        // --- COMPRA ---
        const codOverlay = document.getElementById('cod-overlay');
        const codModal = document.getElementById('cod-modal');
        const closeCodBtn = document.getElementById('close-cod-btn');
        const codForm = document.getElementById('cod-form');
        const codSubmitBtn = document.getElementById('cod-submit-btn');
        const codLoader = document.getElementById('cod-loader');
        const codBtnText = document.getElementById('cod-btn-text');
        const codStatus = document.getElementById('cod-status');
        const codProductSummary = document.getElementById('cod-product-summary');

        function openCodModal(productData) {
            currentProductToBuy = productData;
            decoder.innerHTML = productData.name;
            codProductSummary.textContent = `${decoder.value} - $${productData.price}`;
            
            codStatus.textContent = ''; codStatus.classList.add('hidden');
            codOverlay.classList.remove('hidden'); codModal.classList.remove('hidden');
            codOverlay.classList.add('visible'); codModal.classList.add('visible');
        }

        function closeCodModal() {
            codOverlay.classList.remove('visible'); codModal.classList.remove('visible');
            codOverlay.classList.add('hidden'); codModal.classList.add('hidden');
            codForm.reset();
            currentProductToBuy = null;
        }

        closeCodBtn.addEventListener('click', closeCodModal);
        codOverlay.addEventListener('click', closeCodModal);

        async function saveOrder(method, total, items, customerDetails = {}) {
            const orderData = {
                payment_method: method,
                total_amount: total,
                items: items,
                customer_name: customerDetails.name || null,
                customer_address: customerDetails.address || null,
                customer_reference: customerDetails.reference || null,
                customer_phone: customerDetails.phone || null,
                status: 'pendiente'
            };
            const { error } = await _supabase.from('orders').insert([orderData]);
            return { error };
        }

        codForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentProductToBuy) return;

            codSubmitBtn.disabled = true;
            codLoader.classList.remove('hidden');
            codBtnText.textContent = 'Procesando...';

            const customerDetails = {
                name: document.getElementById('cod-name').value,
                address: document.getElementById('cod-address').value,
                reference: document.getElementById('cod-reference').value,
                phone: document.getElementById('cod-phone').value
            };

            const items = [{
                id: currentProductToBuy.id,
                name: currentProductToBuy.name,
                price: parseFloat(currentProductToBuy.price),
                imageUrl: currentProductToBuy.imageUrl
            }];

            const { error } = await saveOrder('cod', items[0].price, items, customerDetails);

            if (error) {
                codStatus.textContent = `Error: ${error.message}`;
                codStatus.className = 'status-message error';
                codStatus.classList.remove('hidden');
            } else {
                codStatus.textContent = '¬°Pedido realizado con √©xito!';
                codStatus.className = 'status-message success';
                codStatus.classList.remove('hidden');
                setTimeout(closeCodModal, 2500);
            }
            
            codSubmitBtn.disabled = false;
            codLoader.classList.add('hidden');
            codBtnText.textContent = 'Confirmar Pedido';
        });

        // --- AUTH ---
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showLogin = document.getElementById('show-login');
        const showRegister = document.getElementById('show-register');
        const loginStatus = document.getElementById('login-status');

        showRegister.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); loginStatus.classList.add('hidden'); });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); loginStatus.classList.add('hidden'); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await _supabase.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value });
            if (error) { loginStatus.textContent = 'Credenciales incorrectas'; loginStatus.className = 'status-message error'; loginStatus.classList.remove('hidden'); }
            else { window.location.hash = '#admin'; }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await _supabase.auth.signUp({ email: document.getElementById('register-email').value, password: document.getElementById('register-password').value });
            if (error) { loginStatus.textContent = error.message; loginStatus.className = 'status-message error'; }
            else { loginStatus.textContent = 'Revisa tu email.'; loginStatus.className = 'status-message success'; registerForm.reset(); }
            loginStatus.classList.remove('hidden');
        });

        document.getElementById('logout-btn').addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.hash = '#shop'; });

        // --- ADMIN ---
        const productForm = document.getElementById('product-form');
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn'); const ldr = document.getElementById('loader'); const txt = document.getElementById('btn-text');
            btn.disabled = true; ldr.classList.remove('hidden'); txt.textContent = 'Guardando...';
            
            try {
                const name = document.getElementById('product-name').value;
                const desc = document.getElementById('product-description').value;
                const price = document.getElementById('product-price').value;
                const category = document.getElementById('product-category').value;
                const file = document.getElementById('product-image').files[0];

                const fileName = `${Date.now()}-${file.name}`;
                const { error: upErr } = await _supabase.storage.from('product-images').upload(fileName, file);
                if (upErr) throw upErr;
                const { data: urlData } = _supabase.storage.from('product-images').getPublicUrl(fileName);

                const { error: insErr } = await _supabase.from('products').insert([{ 
                    name, price, category, description: desc, image_url: urlData.publicUrl 
                }]);
                if (insErr) throw insErr;

                showStatus('Guardado correctamente', 'success');
                productForm.reset(); document.getElementById('file-name').textContent = 'Ning√∫n archivo';
                productsLoaded = false; loadAdminProducts();
            } catch (err) { showStatus(err.message, 'error'); }
            finally { btn.disabled = false; ldr.classList.add('hidden'); txt.textContent = 'Guardar Producto'; }
        });

        document.getElementById('product-image').addEventListener('change', (e) => {
            document.getElementById('file-name').textContent = e.target.files[0] ? e.target.files[0].name : 'Ning√∫n archivo';
        });

        function showStatus(msg, type) {
            const st = document.getElementById('admin-status'); st.textContent = msg; st.className = `status-message ${type}`; st.classList.remove('hidden');
        }

        // --- EDIT PRODUCT ---
        const editForm = document.getElementById('edit-product-form');
        const editModal = document.getElementById('edit-product-modal');
        const editOverlay = document.getElementById('edit-product-overlay');
        const editFileInput = document.getElementById('edit-product-image');

        function openEditModal(ds) {
            decoder.innerHTML = ds.name;
            document.getElementById('edit-product-id').value = ds.id;
            document.getElementById('edit-product-name').value = decoder.value;
            
            // CORRECCI√ìN: Decodificaci√≥n robusta de la descripci√≥n
            let desc = '';
            if (ds.descriptionEncoded && ds.descriptionEncoded !== 'undefined' && ds.descriptionEncoded !== 'null') {
                try { 
                    desc = decodeURIComponent(ds.descriptionEncoded); 
                } catch(e) { 
                    console.error("Error decodificando descripci√≥n", e);
                    desc = ''; 
                }
            }
            
            document.getElementById('edit-product-description').value = desc; 
            
            document.getElementById('edit-product-price').value = ds.price;
            document.getElementById('edit-product-category').value = ds.category;
            document.getElementById('edit-old-image-url').value = ds.imageUrl;
            
            editFileInput.value = ''; 
            document.getElementById('edit-file-name').textContent = 'Ning√∫n archivo nuevo';
            
            editOverlay.classList.remove('hidden'); 
            editModal.classList.remove('hidden');
            editOverlay.classList.add('visible'); 
            editModal.classList.add('visible');
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('edit-submit-btn'); const ldr = document.getElementById('edit-loader'); const txt = document.getElementById('edit-btn-text');
            btn.disabled = true; ldr.classList.remove('hidden'); txt.textContent = 'Guardando...';

            const id = document.getElementById('edit-product-id').value;
            const data = {
                name: document.getElementById('edit-product-name').value,
                description: document.getElementById('edit-product-description').value,
                price: document.getElementById('edit-product-price').value,
                category: document.getElementById('edit-product-category').value
            };
            const file = editFileInput.files[0];

            try {
                if (file) {
                    const fileName = `${Date.now()}-${file.name}`;
                    await _supabase.storage.from('product-images').upload(fileName, file);
                    const { data: url } = _supabase.storage.from('product-images').getPublicUrl(fileName);
                    data.image_url = url.publicUrl;
                    
                    const oldUrl = document.getElementById('edit-old-image-url').value;
                    const oldName = oldUrl.split('product-images/')[1];
                    if (oldName) await _supabase.storage.from('product-images').remove([oldName]);
                }
                await _supabase.from('products').update(data).eq('id', id);
                productsLoaded = false; 
                loadAdminProducts(); 
                editOverlay.classList.remove('visible'); editModal.classList.remove('visible');
                editOverlay.classList.add('hidden'); editModal.classList.add('hidden');
            } catch (err) { console.error(err); }
            finally { btn.disabled = false; ldr.classList.add('hidden'); txt.textContent = 'Guardar Cambios'; }
        });

        document.getElementById('close-edit-modal-btn').addEventListener('click', () => { editOverlay.classList.remove('visible'); editModal.classList.remove('visible'); editOverlay.classList.add('hidden'); editModal.classList.add('hidden'); });
        editFileInput.addEventListener('change', (e) => document.getElementById('edit-file-name').textContent = e.target.files[0] ? e.target.files[0].name : 'Ning√∫n archivo');

        // --- GLOBAL CLICKS ---
        document.addEventListener('click', (e) => {
            // Bot√≥n Comprar
            const buyBtn = e.target.closest('.buy-btn');
            if (buyBtn) {
                e.stopPropagation();
                const productData = {
                    id: buyBtn.dataset.id,
                    name: buyBtn.dataset.name,
                    price: buyBtn.dataset.price,
                    imageUrl: buyBtn.dataset.imageUrl
                };
                openCodModal(productData);
                return;
            }

            // Click en Tarjeta (Detalles)
            const card = e.target.closest('.product-card');
            if (card) {
                const productData = {
                    id: card.dataset.id,
                    name: card.dataset.name,
                    price: card.dataset.price,
                    imageUrl: card.dataset.imageUrl,
                    description: card.dataset.description 
                };
                openDetailsModal(productData);
                return;
            }

            // Acciones Admin
            if (e.target.closest('.btn-delete')) {
                const btn = e.target.closest('.btn-delete');
                if(confirm('¬øEliminar?')) {
                    _supabase.from('products').delete().eq('id', btn.dataset.id).then(() => {
                        const fname = btn.dataset.imageUrl.split('product-images/')[1];
                        if(fname) _supabase.storage.from('product-images').remove([fname]);
                        productsLoaded = false; loadAdminProducts();
                    });
                }
            }
            if (e.target.closest('.btn-edit')) {
                const btn = e.target.closest('.btn-edit');
                openEditModal(btn.dataset);
            }
            if (e.target.closest('.btn-mark-sent')) {
                _supabase.from('orders').update({status:'enviado'}).eq('id', e.target.closest('.btn-mark-sent').dataset.id).then(loadOrders);
            }
            if (e.target.closest('.btn-delete-order')) {
                if(confirm('¬øEliminar pedido?')) _supabase.from('orders').delete().eq('id', e.target.closest('.btn-delete-order').dataset.id).then(loadOrders);
            }
        });

        // --- HELPERS (Admin Lists & Info) ---
        async function loadAdminProducts() {
            const list = document.getElementById('admin-products-list');
            list.innerHTML = '';
            const { data } = await _supabase.from('products').select('*').order('created_at', { ascending: false });
            if (data) {
                data.forEach(p => {
                    const div = document.createElement('div'); div.className = 'admin-product-card';
                    // USAR URI Encoding para seguridad en dataset
                    const encodedDesc = encodeURIComponent(p.description || '');
                    
                    div.innerHTML = `
                        <img src="${p.image_url}">
                        <div class="admin-product-info"><h4>${p.name}</h4><p>$${p.price}</p></div>
                        <div class="admin-product-actions">
                            <button class="btn-edit" 
                                data-id="${p.id}" 
                                data-name="${escapeHTML(p.name)}" 
                                data-price="${p.price}" 
                                data-category="${p.category}" 
                                data-description-encoded="${encodedDesc}" 
                                data-image-url="${p.image_url}">Editar</button>
                            <button class="btn-delete" data-id="${p.id}" data-image-url="${p.image_url}">Eliminar</button>
                        </div>`;
                    list.appendChild(div);
                });
            }
            document.getElementById('loading-admin-products-message').style.display = 'none';
        }

        async function loadOrders() {
            const list = document.getElementById('orders-list'); list.innerHTML = '';
            const { data } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
            if (data) {
                data.forEach(o => {
                    const div = document.createElement('div'); div.className = 'order-card';
                    div.innerHTML = `<div class="order-header"><p><strong>${new Date(o.created_at).toLocaleDateString()}</strong></p><p>${o.status}</p></div>
                    <p>${o.items[0].name} - $${o.total_amount}</p>
                    <p>${o.customer_name} - ${o.customer_phone}</p>
                    <div style="margin-top:0.5rem"><button class="btn-mark-sent" data-id="${o.id}">Enviado</button> <button class="btn-delete-order" data-id="${o.id}">Borrar</button></div>`;
                    list.appendChild(div);
                });
            }
            document.getElementById('loading-orders-message').style.display = 'none';
        }

        // Logos, Info, Maps
        const logoForm = document.getElementById('logo-upload-form');
        const infoForm = document.getElementById('info-form');
        
        logoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('logo-image').files[0];
            if(file) {
                const name = `logo/store-logo-${Date.now()}`;
                await _supabase.storage.from('product-images').upload(name, file);
                const {data} = _supabase.storage.from('product-images').getPublicUrl(name);
                await _supabase.from('store_settings').upsert({setting_name:'logo_url', value: data.publicUrl});
                
                const img = document.getElementById('store-logo-img');
                if(img) {
                    img.src = data.publicUrl;
                    img.style.display = 'block';
                }
                
                document.getElementById('logo-status').textContent = 'Logo actualizado';
                document.getElementById('logo-status').classList.remove('hidden');
            }
        });

        infoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const contact = document.getElementById('admin-contact-info').value;
            const address = document.getElementById('admin-address-info').value;
            const map = document.getElementById('admin-map-src').value;
            await _supabase.from('store_settings').upsert([
                {setting_name:'contact_info', value: contact},
                {setting_name:'address_info', value: address},
                {setting_name:'map_embed_src', value: map}
            ]);
            document.getElementById('footer-contact').textContent = contact;
            document.getElementById('footer-address').textContent = address;
            if(map) document.getElementById('map-container').innerHTML = `<iframe src="${map}" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`;
            document.getElementById('info-status').textContent = 'Info actualizada';
            document.getElementById('info-status').classList.remove('hidden');
        });

        async function loadStoreInfo() {
            const { data } = await _supabase.from('store_settings').select('*');
            if(data) {
                data.forEach(s => {
                    if(s.setting_name === 'logo_url') { 
                        const img = document.getElementById('store-logo-img');
                        if(img) {
                            img.src = s.value; 
                            img.style.display = 'block'; 
                        }
                    }
                    if(s.setting_name === 'contact_info') { document.getElementById('footer-contact').textContent = s.value; document.getElementById('admin-contact-info').value = s.value; }
                    if(s.setting_name === 'address_info') { document.getElementById('footer-address').textContent = s.value; document.getElementById('admin-address-info').value = s.value; }
                    if(s.setting_name === 'map_embed_src' && s.value) {
                        document.getElementById('map-container').innerHTML = `<iframe src="${s.value}" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`;
                        document.getElementById('admin-map-src').value = s.value;
                    }
                });
            }
        }

        window.addEventListener('hashchange', handleRouting);
        document.addEventListener('DOMContentLoaded', () => {
            handleRouting();
            loadStoreInfo();
            _supabase.auth.onAuthStateChange((e, s) => {
                document.getElementById('login-nav-link').classList.toggle('hidden', !!s);
                document.getElementById('admin-nav-link').classList.toggle('hidden', !s);
            });
        });
    </script>

    <a href="https://wa.me/50375460299" target="_blank" class="whatsapp-flotante">
        <img src="https://pub-0c024c9a5a7a439aa0319b5140a52857.r2.dev/6c784972cbf5806215d46fbda8b0c46a.jpg" alt="WhatsApp">
    </a>
</body>
</html>
