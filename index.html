<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Cell Smar</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Importar Fuente Moderna (Poppins) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            /* Fuente Importada */
            --font-main: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

            /* Paleta Moderna "Llamativa" (Premium Dark / Azul) */
            --color-bg: #0F172A; /* Azul Oscuro (Slate 900) */
            --color-card-bg: #1E293B; /* Azul Gris (Slate 800) */
            --color-text: #F1F5F9; /* Casi Blanco (Slate 100) */
            --color-text-muted: #94A3B8; /* Gris Claro (Slate 400) */
            --color-border: #334155; /* Borde Sutil (Slate 700) */
            
            /* Acentos Vibrantes (El toque "Llamativo") */
            --color-primary-start: #38BDF8; /* Azul (Sky 400) */
            --color-primary-end: #EC4899;   /* Rosa (Pink 500) */
            --gradient-primary: linear-gradient(90deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%);

            /* Colores de Estado (Ajustados para más brillo) */
            --color-success: #22C55E; /* Verde (Green 500) */
            --color-danger: #F43F5E;  /* Rojo (Rose 500) */

            /* Sombra y Borde */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --border-radius: 10px; /* Un poco más redondeado */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main); /* Aplicar nueva fuente */
            line-height: 1.6;
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        .hidden { display: none !important; }

        /* --- Estilos de Navegación --- */
        nav {
            background-color: var(--color-card-bg);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            /* Borde inferior con gradiente */
            border-bottom: 4px solid;
            border-image: var(--gradient-primary) 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* Contenedor para logo y título */
        .nav-branding {
            display: flex;
            align-items: center;
            gap: 1rem; /* Espacio entre logo y título */
        }
        /* Estilos para el logo en la NAV */
        #store-logo-img {
            height: 70px; /* <- MODIFICADO (antes 55px) */
            width: auto;
            display: none; /* Oculto por defecto, JS lo muestra si existe */
            border-radius: 4px; /* Opcional: bordes redondeados */
        }

        nav h1 {
            margin: 0;
            font-size: 1.75rem; /* Un poco más grande */
            font-weight: 700;
            /* Texto con Gradiente */
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        nav a {
            text-decoration: none;
            color: var(--color-text); /* Color de texto normal */
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }
        nav a:hover { background-color: var(--color-border); } /* Hover sutil */

        #cart-count {
            background-color: var(--color-danger);
            color: #fff;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            vertical-align: super;
            margin-left: 2px;
        }

        /* --- Estilos Generales de Contenedor --- */
        main { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        section { padding: 1rem; }

        /* --- 1. Estilos de la TIENDA --- */
        #loading-message { font-size: 1.2rem; text-align: center; padding: 2rem; color: var(--color-text-muted); }

        .category-title {
            font-size: 2rem; /* Más grande */
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-border);
            /* Texto con Gradiente */
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .product-card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border); /* Borde sutil */
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-8px); /* Elevar más */
            border-color: var(--color-primary-start); /* Borde de resplandor */
            /* Sombra de resplandor "Llamativa" */
            box-shadow: 0 8px 20px rgba(0,0,0,0.5), 0 0 15px rgba(56, 189, 248, 0.3);
        }
        .product-image-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            cursor: pointer;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .product-image-container:hover .product-image {
             transform: scale(1.05);
        }
        .product-info {
            padding: 1.25rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .product-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em;
            word-break: break-word;
        }
        .product-price { 
            font-size: 1.15rem; 
            color: var(--color-primary-start); /* Color de acento */
            font-weight: 700; 
            margin-bottom: 1rem; 
        }
        
        /* Botones con Gradiente */
        .cart-btn, button[type="submit"] {
            padding: 0.75rem;
            background: var(--gradient-primary); /* Fondo de Gradiente */
            color: #ffffff;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            background-size: 200% auto; /* Para animación de hover */
            transition: background-position 0.4s ease, transform 0.2s ease;
            margin-top: auto;
        }
        .cart-btn:hover, button[type="submit"]:not(:disabled):hover {
            background-position: right center; /* Animación de gradiente */
            transform: scale(1.03); /* Efecto pop */
        }
        /* Ajuste para botón de 'Proceder al Pago' */
        #checkout-btn {
            margin-top: 0;
            padding: 0.85rem;
        }

        /* --- 2. Estilos de LOGIN y ADMIN (Formularios) --- */
        .form-container, #orders-container, #admin-products-container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 2.5rem;
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
             /* Borde superior con gradiente */
            border-top: 4px solid;
            border-image: var(--gradient-primary) 1;
        }
        .form-container h2 { text-align: center; margin-bottom: 2rem; color: var(--color-text); }
        form { display: grid; gap: 1.25rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text); }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%; padding: 0.75rem; border: 1px solid var(--color-border);
            border-radius: var(--border-radius); font-size: 1rem;
            background-color: var(--color-bg); /* Fondo de input más oscuro */
            color: var(--color-text);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--color-primary-start);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3);
        }

        /* Texto de ayuda para el formulario */
        .form-group-help-text {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-top: -0.75rem; /* Acercarlo al input */
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .file-label {
            display: inline-block; padding: 0.75rem 1rem; 
            background-color: var(--color-border); /* Botón de archivo */
            border: 1px solid var(--color-border); border-radius: var(--border-radius);
            cursor: pointer; transition: background-color 0.2s; text-align: center;
            color: var(--color-text);
        }
        .file-label:hover { background-color: #334155; }
        #file-name, #edit-file-name {
            font-style: italic; color: var(--color-text-muted); margin-top: 0.5rem; text-align: center;
        }
        #logo-file-name {
            font-style: italic; color: var(--color-text-muted); margin-top: 0.5rem; text-align: center;
        }

        /* Botón de submit ya está estilizado arriba */
        button[type="submit"] {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 0.85rem;
        }
        button[type="submit"]:disabled {
            background: #334155; /* Fondo deshabilitado */
            cursor: not-allowed;
            color: #999;
            transform: none;
        }

        .form-toggle-links {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }
        .form-toggle-links a {
            color: var(--color-primary-start); /* Color de acento */
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
        }

        #logout-btn {
            width: 100%; padding: 0.75rem; background-color: var(--color-danger); color: #fff;
            border: none; border-radius: var(--border-radius); cursor: pointer;
            font-size: 1rem; font-weight: 600; margin-top: 1rem;
            transition: background-color 0.2s, transform 0.2s;
        }
         #logout-btn:hover {
             background-color: #c2334e;
             transform: scale(1.03);
         }

        .loader {
            width: 18px; height: 18px; border: 2px solid #fff;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-message {
            text-align: center; font-weight: 600; margin-top: 1.5rem;
            padding: 0.75rem; border-radius: var(--border-radius);
            border-width: 1px;
            border-style: solid;
        }
        .success { background-color: rgba(34, 197, 94, 0.1); color: var(--color-success); border-color: var(--color-success); }
        .error { background-color: rgba(244, 63, 94, 0.1); color: var(--color-danger); border-color: var(--color-danger); }

        /* Estilos para el contenedor del Mapa */
        #map-container {
            max-width: 1200px; /* Igual al 'main' */
            margin: 3rem auto; /* Espacio arriba y abajo */
            overflow: hidden; 
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow);
            background-color: var(--color-card-bg);
            min-height: 100px; /* Altura mínima mientras carga */
        }
        /* Estilos para el iframe del mapa */
        #map-container iframe {
            width: 100% !important; /* Forzar ancho responsivo */
            height: 400px; /* Altura del mapa */
            border: 0;
            display: block; /* Eliminar espacio inferior */
        }

        /* Estilos del Footer */
        footer { 
            text-align: center; 
            padding: 2.5rem 1rem; /* Más padding */
            margin-top: 2rem; 
            color: var(--color-text-muted); /* Color grisáceo para TODO el texto */
            border-top: 1px solid var(--color-border); /* Borde superior */
            display: flex;
            flex-direction: column; /* Apilar elementos */
            align-items: center;
            gap: 0.75rem; /* Espacio entre líneas */
        }
        footer p {
            margin: 0;
            line-height: 1.5;
        }
        /* Estilo específico para contacto/dirección eliminado */


        /* --- ESTILOS DE TODOS LOS MODALES --- */
        #cart-overlay, #cod-overlay, #edit-product-overlay, #image-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.8); /* Fondo azulado oscuro */
            backdrop-filter: blur(5px); /* Efecto blur */
            display: none;
        }
        #cart-modal, #cod-modal, #edit-product-modal, #image-modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-card-bg);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            width: 90%; display: none;
            color: var(--color-text);
            border-top: 4px solid; /* Borde de gradiente en modales */
            border-image: var(--gradient-primary) 1;
        }

        #cart-overlay { z-index: 90; }
        #cart-modal { z-index: 91; max-width: 550px; }

        #cod-overlay { z-index: 102; }
        #cod-modal { z-index: 103; max-width: 500px; }

        #edit-product-overlay { z-index: 104; }
        #edit-product-modal { z-index: 105; max-width: 500px; }

        /* Estilos para el modal de imagen */
        #image-modal-overlay { z-index: 110; }
        #image-modal {
            z-index: 111;
            max-width: 90vw;
            max-height: 90vh;
            padding: 0; /* Sin padding */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
            box-shadow: none;
            border: none; /* Sin borde de gradiente */
        }
        #modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
            border: 2px solid var(--color-border);
        }
        #close-image-modal-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 112;
            color: #ccc;
            font-size: 3rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
         #close-image-modal-btn:hover { color: #fff; }

        #cart-overlay.visible, #cart-modal.visible,
        #cod-overlay.visible, #cod-modal.visible,
        #edit-product-overlay.visible, #edit-product-modal.visible,
        #image-modal-overlay.visible, #image-modal.visible {
            display: block;
        }
        #image-modal.visible { display: flex; }


        #cart-items-list { max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
        .cart-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--color-border);
            gap: 1rem;
        }
        .cart-item:last-child { border-bottom: none; }

        .cart-item-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--color-border);
        }

        .cart-item-name {
            font-weight: 600;
            color: var(--color-text);
            flex-grow: 1;
            margin-right: 1rem;
        }
        .cart-item-price {
            color: var(--color-text-muted);
            white-space: nowrap;
        }

        #cod-modal h2, #edit-product-modal h2 { text-align: center; }
        #cod-modal h2, #edit-product-modal h2 { margin-bottom: 1rem; }

        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2.5rem; color: #aaa; background: none; border: none; cursor: pointer; line-height: 1; }
        .close-btn:hover { color: #fff; }

        /* Estilos para la lista de pedidos del Admin */
        #orders-container, #admin-products-container {
            max-width: 900px;
            margin: 3rem auto;
        }
        #admin-products-container {
             max-width: 900px;
        }
        .form-container {
            max-width: 900px; /* Ancho para el form de productos */
        }
        /* Contenedores de admin más pequeños */
        #logo-upload-form-container, #info-form-container {
            max-width: 500px;
        }


        #orders-container h2, #admin-products-container h2 {
             color: var(--color-text);
             text-align: center; 
             margin-bottom: 2rem;
        }
        .order-card {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: var(--color-bg); /* Fondo más oscuro */
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }
        .order-header p { margin: 0; color: var(--color-text-muted); }
        .order-header p strong { color: var(--color-text); }
        .order-total { font-size: 1.2rem; font-weight: bold; color: var(--color-primary-start); }
        .order-items-list { list-style-type: none; padding-left: 0; }
        .order-items-list li { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; color: var(--color-text); }

        .order-status {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 5px;
            color: #fff;
            text-transform: capitalize;
        }
        .order-status.pendiente { background-color: var(--color-danger); }
        .order-status.enviado { background-color: var(--color-success); }

        .order-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--color-border);
            padding-top: 1rem;
        }
        .order-actions button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s, transform 0.2s;
        }
        .order-actions button:hover {
            transform: scale(1.05);
        }

        .btn-mark-sent { background-color: var(--color-success); }
        .btn-mark-sent:hover { background-color: #1a9c4a; }
        .btn-mark-sent:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
            color: #aaa;
            transform: none;
        }
        .btn-delete-order { background-color: var(--color-danger); }
        .btn-delete-order:hover { background-color: #c2334e; }

        /* Estilos para la lista de productos del Admin */
        #admin-products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .admin-product-card {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            background-color: var(--color-bg); /* Fondo más oscuro */
        }
        .admin-product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .admin-product-info {
            padding: 1rem;
            flex-grow: 1;
        }
        .admin-product-info h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.2em;
            word-break: break-word;
        }
        .admin-product-info p { color: var(--color-text-muted); }

        .admin-product-category {
            font-size: 0.85rem;
            color: var(--color-primary-start); /* Color acento */
            font-style: italic;
            margin-top: 0.5rem;
        }

        .admin-product-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-top: 1px solid var(--color-border);
        }
        .admin-product-actions button {
            padding: 0.75rem;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-edit {
            color: var(--color-primary-start);
            border-right: 1px solid var(--color-border);
        }
        .btn-edit:hover { background-color: rgba(56, 189, 248, 0.1); }
        .btn-delete { color: var(--color-danger); }
        .btn-delete:hover { background-color: rgba(244, 63, 94, 0.1); }
    </style>
    </head>
<body>

    <nav>
        <div class="nav-branding">
            <img src="" id="store-logo-img" alt="Logo">
            <h1><a href="#shop" style="text-decoration:none; color:inherit;">Tienda Cell Smar</a></h1>
        </div>
        <div>
            <a href="#shop">Tienda</a>
            <a href="#login" id="login-nav-link">👤 Iniciar Sesión</a>
            <a href="#admin" id="admin-nav-link" class="hidden">⚙️ Admin</a>
            <a href="#" id="cart-toggle" title="Ver Carrito">
                🛒 Carrito (<span id="cart-count">0</span>)
            </a>
        </div>
    </nav>

    <main>
        <section id="shop-section">
            <div id="shop-categories-container"></div>
            <p id="loading-message">Cargando productos...</p>
        </section>

        <section id="login-section" class="hidden">
            <div class="form-container" id="login-form-container">
                <form id="login-form">
                    <h2>Admin Login</h2>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" id="login-btn">
                        <span id="login-btn-text">Iniciar Sesión</span>
                    </button>
                    <div class="form-toggle-links">
                        ¿No tienes cuenta? <a id="show-register">Regístrate</a>
                    </div>
                </form>
                <form id="register-form" class="hidden">
                    <h2>Registrarse</h2>
                    <div class="form-group">
                        <label for="register-email">Email:</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Contraseña:</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <button type="submit" id="register-btn">
                        <span id="register-btn-text">Crear Cuenta</span>
                    </button>
                    <div class="form-toggle-links">
                        ¿Ya tienes cuenta? <a id="show-login">Inicia Sesión</a>
                    </div>
                </form>
                <div id="login-status" class="status-message"></div>
            </div>
        </section>

        <section id="admin-section" class="hidden">
            <div class="form-container">
                <h2>Cargar Nuevo Producto</h2>
                <form id="product-form">
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto:</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Precio:</label>
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">Categoría:</label>
                        <select id="product-category" required>
                            <option value="">-- Selecciona Categoría --</option>
                            <option value="Cambios de Pantalla">Cambios de Pantalla</option>
                            <option value="Cables de Carga">Cables de Carga</option>
                            <option value="Cargadores Samsung">Cargadores Samsung</option>
                            <option value="Cargadores de Iphone">Cargadores de Iphone</option>
                            <option value="Bandejas de SIM">Bandejas de SIM</option>
                            <option value="Protectores Fisicos de Iphone">Protectores Fisicos de Iphone</option>
                            <option value="Protectores Fisicos Samsung">Protectores Fisicos Samsung</option>
                            <option value="Chanclas Adidas Originales">Chanclas Adidas Originales</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-image" class="file-label">
                            Haz clic para subir una imagen
                        </label>
                        <input type="file" id="product-image" accept="image/*" class="hidden" required>
                        <div id="file-name">Ningún archivo seleccionado</div>
                    </div>
                    <button type="submit" id="submit-btn">
                        <span id="loader" class="loader hidden"></span>
                        <span id="btn-text">Guardar Producto</span>
                    </button>
                </form>
                <div id="admin-status" class="status-message"></div>
                <button id="logout-btn">Cerrar Sesión</button>
            </div>

            <div class="form-container" id="logo-upload-form-container">
                <h2>Configuración de la Tienda</h2>
                <form id="logo-upload-form">
                    <div class="form-group">
                        <label for="logo-image" class="file-label">
                            Subir/Actualizar Logo de la Tienda
                        </label>
                        <input type="file" id="logo-image" accept="image/*" class="hidden">
                        <div id="logo-file-name">Ningún archivo seleccionado</div>
                    </div>
                    <button type="submit" id="logo-submit-btn">
                        <span id="logo-loader" class="loader hidden"></span>
                        <span id="logo-btn-text">Guardar Logo</span>
                    </button>
                </form>
                <div id="logo-status" class="status-message hidden"></div>
            </div>
            
            <div class="form-container" id="info-form-container">
                <h2>Información Pública (Footer y Mapa)</h2>
                <form id="info-form">
                    <div class="form-group">
                        <label for="admin-contact-info">Información de Contacto:</label>
                        <input type="text" id="admin-contact-info" placeholder="Ej: Tel: 555-1234, Email: info@tienda.com">
                    </div>
                    <div class="form-group">
                        <label for="admin-address-info">Dirección:</label>
                        <input type="text" id="admin-address-info" placeholder="Ej: Calle Falsa 123, Ciudad, País">
                    </div>

                    <div class="form-group">
                        <label for="admin-map-src">URL de Google Maps (Embed):</label>
                        <input type="text" id="admin-map-src" placeholder="Pega aquí solo la URL 'src'">
                    </div>
                    <p class="form-group-help-text">
                        Ve a Google Maps > Compartir > Insertar un mapa > Copia solo la URL de `src="..."`
                    </p>

                    <button type="submit" id="info-submit-btn">
                        <span id="info-loader" class="loader hidden"></span>
                        <span id="info-btn-text">Guardar Información</span>
                    </button>
                </form>
                <div id="info-status" class="status-message hidden"></div>
            </div>


            <div id="orders-container">
                <h2>Pedidos Recibidos</h2>
                <div id="orders-list"></div>
                <p id="loading-orders-message">Cargando pedidos...</p>
            </div>
            <div id="admin-products-container">
                <h2>Gestionar Productos</h2>
                <div id="admin-products-list"></div>
                <p id="loading-admin-products-message">Cargando productos...</p>
                <div id="admin-products-status" class="status-message hidden"></div>
            </div>
        </section>

    </main>

    <div id="cart-overlay" class="hidden"></div>
    <div id="cart-modal" class="hidden">
        <button id="close-cart-btn" class="close-btn">×</button>
        <h2>Tu Carrito</h2>
        <div id="cart-items-list"><p>Tu carrito está vacío.</p></div>
        <hr style="margin: 1.5rem 0; border-color: var(--color-border);">
        <h3 style="text-align: right; margin-bottom: 1.5rem;">Total: <span id="cart-total">$0.00</span></h3>
        <button type="submit" id="checkout-btn" class="cart-btn">Proceder al Pago</button>
    </div>

    <div id="cod-overlay" class="hidden"></div>
    <div id="cod-modal" class="hidden">
        <button id="close-cod-btn" class="close-btn">×</button>
        <h2>Datos para Contra Entrega</h2>
        <form id="cod-form">
            <div class="form-group">
                <label for="cod-name">Nombre Completo:</label>
                <input type="text" id="cod-name" required>
            </div>
            <div class="form-group">
                <label for="cod-address">Dirección de Entrega:</label>
                <input type="text" id="cod-address" required>
            </div>
            <div class="form-group">
                <label for="cod-reference">Punto de Referencia (Opcional):</label>
                <input type="text" id="cod-reference">
            </div>
            <div class="form-group">
                <label for="cod-phone">Número de Teléfono:</label>
                <input type="text" id="cod-phone" required>
            </div>
            <button type="submit" id="cod-submit-btn">
                <span id="cod-loader" class="loader hidden"></span>
                <span id="cod-btn-text">Confirmar Pedido</span>
            </button>
        </form>
        <div id="cod-status" class="status-message hidden"></div>
    </div>

    <div id="edit-product-overlay" class="hidden"></div>
    <div id="edit-product-modal" class="hidden">
        <button id="close-edit-modal-btn" class="close-btn">×</button>
        <h2>Editar Producto</h2>
        <form id="edit-product-form">
            <input type="hidden" id="edit-product-id">
            <input type="hidden" id="edit-old-image-url">
            <div class="form-group">
                <label for="edit-product-name">Nombre del Producto:</label>
                <input type="text" id="edit-product-name" required>
            </div>
            <div class="form-group">
                <label for="edit-product-price">Precio:</label>
                <input type="number" id="edit-product-price" step="0.01" min="0" required>
            </div>
             <div class="form-group">
                <label for="edit-product-category">Categoría:</label>
                <select id="edit-product-category" required>
                    <option value="">-- Selecciona Categoría --</option>
                    <option value="Cambios de Pantalla">Cambios de Pantalla</option>
                    <option value="Cables de Carga">Cables de Carga</option>
                    <option value="Cargadores Samsung">Cargadores Samsung</option>
                    <option value="Cargadores de Iphone">Cargadores de Iphone</option>
                    <option value="Bandejas de SIM">Bandejas de SIM</option>
                    <option value="Protectores Fisicos de Iphone">Protectores Fisicos de Iphone</option>
                    <option value="Protectores Fisicos Samsung">Protectores Fisicos Samsung</option>
                    <option value="Chanclas Adidas Originales">Chanclas Adidas Originales</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-product-image" class="file-label">
                    Cambiar imagen (Opcional)
                </label>
                <input type="file" id="edit-product-image" accept="image/*" class="hidden">
                <div id="edit-file-name">Ningún archivo nuevo</div>
            </div>
            <button type="submit" id="edit-submit-btn">
                <span id="edit-loader" class="loader hidden"></span>
                <span id="edit-btn-text">Guardar Cambios</span>
            </button>
        </form>
        <div id="edit-product-status" class="status-message hidden"></div>
    </div>

    <div id="image-modal-overlay" class="hidden"></div>
    <div id="image-modal" class="hidden">
        <button id="close-image-modal-btn" class="close-btn">×</button>
        <img src="" alt="Imagen Ampliada" id="modal-image">
    </div>

    <div id="map-container">
        </div>

    <footer>
        <p id="footer-contact">Cargando contacto...</p>
        <p id="footer-address">Cargando dirección...</p>
        <p id="footer-copyright">© 2025 Cell Smar. Todos los derechos reservados.</p>
    </footer>

    <script>
        // --- CONFIGURACIÓN E INICIALIZACIÓN ---
        const SUPABASE_URL = 'https://kbvheywmgxkpigoldhuw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtidmhleXdtZ3hrcGlnb2xkaHV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODYzOTQsImV4cCI6MjA3NjY2MjM5NH0.KNK1dmVI5iAvKcIdLAjjyhzrLun3ZgwQe1LIuBhgZU0';

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let cart = [];
        let productsLoaded = false;

        const shopSection = document.getElementById('shop-section');
        const loginSection = document.getElementById('login-section');
        const adminSection = document.getElementById('admin-section');
        const sections = [shopSection, loginSection, adminSection];
        const decoder = document.createElement('textarea');

        // --- ENRUTADOR (Router) ---
        async function handleRouting() {
            const hash = window.location.hash || '#shop';
            sections.forEach(s => s.classList.add('hidden'));

            if (hash === '#shop') {
                shopSection.classList.remove('hidden');
                loadProducts();
            } else if (hash === '#login') {
                loginSection.classList.remove('hidden');
            } else if (hash === '#admin') {
                const { data: { session } } = await _supabase.auth.getSession();
                if (session) {
                    adminSection.classList.remove('hidden');
                    loadOrders();
                    loadAdminProducts();
                    // La info de admin se carga al inicio en loadStoreInfo()
                } else {
                    window.location.hash = '#login';
                }
            }
        }

        // --- LÓGICA DE LA TIENDA ---
        const shopCategoriesContainer = document.getElementById('shop-categories-container');
        const loadingMessage = document.getElementById('loading-message');

        // Función corregida
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/&/g, '&amp;');
        }

        async function loadProducts() {
            if (productsLoaded) return;
            loadingMessage.textContent = 'Cargando productos...';
            loadingMessage.style.display = 'block';
            shopCategoriesContainer.innerHTML = '';

            try {
                const { data, error } = await _supabase.from('products').select('*').order('category').order('created_at', { ascending: false });
                if (error) throw error;
                if (data.length === 0) {
                    loadingMessage.textContent = 'Aún no hay productos en la tienda.';
                    return;
                }
                loadingMessage.style.display = 'none';

                const groupedProducts = {};
                data.forEach(product => {
                    const category = product.category || 'Otros';
                    if (!groupedProducts[category]) {
                        groupedProducts[category] = [];
                    }
                    groupedProducts[category].push(product);
                });

                for (const category in groupedProducts) {
                    const categorySection = document.createElement('div');
                    const categoryTitle = document.createElement('h2');
                    categoryTitle.className = 'category-title';
                    categoryTitle.textContent = category;
                    categorySection.appendChild(categoryTitle);

                    const categoryGrid = document.createElement('div');
                    categoryGrid.className = 'product-grid';

                    groupedProducts[category].forEach(product => {
                        const formattedPrice = parseFloat(product.price).toFixed(2);
                        const safeName = escapeHTML(product.name);
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.innerHTML = `
                            <div class="product-image-container">
                                <img src="${product.image_url}" alt="${safeName}" class="product-image product-image-clickable"> 
                            </div>
                            <div class="product-info">
                                <h2 class="product-name">${product.name}</h2>
                                <p class="product-price">$${formattedPrice}</p>
                                <button class="cart-btn"
                                    data-id="${product.id}"
                                    data-name="${safeName}"
                                    data-price="${formattedPrice}"
                                    data-image-url="${product.image_url}">Añadir al Carrito</button>
                            </div>`;
                        categoryGrid.appendChild(card);
                    });

                    categorySection.appendChild(categoryGrid);
                    shopCategoriesContainer.appendChild(categorySection);
                }

                productsLoaded = true;
            } catch (error) {
                console.error('Error cargando productos:', error.message);
                loadingMessage.textContent = `Error al cargar la tienda: ${error.message}`;
            }
        }

        // --- LÓGICA DEL CARRITO ---
        const cartToggle = document.getElementById('cart-toggle');
        const cartCount = document.getElementById('cart-count');
        const cartModal = document.getElementById('cart-modal');
        const cartOverlay = document.getElementById('cart-overlay');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotal = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');

        function addToCart(id, name, price, imageUrl) {
            decoder.innerHTML = name;
            cart.push({ id, name: decoder.value, price: parseFloat(price), imageUrl: imageUrl });
            updateCartCount();
        }
        function updateCartCount() { cartCount.textContent = cart.length; }

        function renderCartItems() {
            cartItemsList.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p>Tu carrito está vacío.</p>';
                checkoutBtn.disabled = true;
            } else {
                cart.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" class="cart-item-image">
                        <span class="cart-item-name">${item.name}</span>
                        <span class="cart-item-price">$${item.price.toFixed(2)}</span>
                    `;
                    cartItemsList.appendChild(itemEl);
                    total += item.price;
                });
                checkoutBtn.disabled = false;
            }
            cartTotal.textContent = `$${total.toFixed(2)}`;
        }

        function openCartModal() {
            renderCartItems();
            cartOverlay.classList.remove('hidden'); cartModal.classList.remove('hidden');
            cartOverlay.classList.add('visible'); cartModal.classList.add('visible');
        }
        function closeCartModal() {
            cartOverlay.classList.remove('visible'); cartModal.classList.remove('visible');
            cartOverlay.classList.add('hidden'); cartModal.classList.add('hidden');
        }

        cartToggle.addEventListener('click', (e) => { e.preventDefault(); openCartModal(); });
        closeCartBtn.addEventListener('click', closeCartModal);
        cartOverlay.addEventListener('click', closeCartModal);

        checkoutBtn.addEventListener('click', () => {
            const total = cart.reduce((acc, item) => acc + item.price, 0);
            if (total <= 0) return;
            closeCartModal();
            openCodModal();
        });

        // --- LÓGICA DEL MODAL DE CONTRA ENTREGA ---
        const codOverlay = document.getElementById('cod-overlay');
        const codModal = document.getElementById('cod-modal');
        const closeCodBtn = document.getElementById('close-cod-btn');
        const codForm = document.getElementById('cod-form');
        const codSubmitBtn = document.getElementById('cod-submit-btn');
        const codLoader = document.getElementById('cod-loader');
        const codBtnText = document.getElementById('cod-btn-text');
        const codStatus = document.getElementById('cod-status');

        function openCodModal() {
            codStatus.textContent = ''; codStatus.classList.add('hidden');
            codOverlay.classList.remove('hidden'); codModal.classList.remove('hidden');
            codOverlay.classList.add('visible'); codModal.classList.add('visible');
        }
        function closeCodModal() {
            codOverlay.classList.remove('visible'); codModal.classList.remove('visible');
            codOverlay.classList.add('hidden'); codModal.classList.add('hidden');
            codForm.reset();
        }

        closeCodBtn.addEventListener('click', closeCodModal);
        codOverlay.addEventListener('click', closeCodModal);

        async function saveOrder(method, total, items, customerDetails = {}) {
            const orderData = {
                payment_method: method,
                total_amount: total,
                items: items,
                customer_name: customerDetails.name || null,
                customer_address: customerDetails.address || null,
                customer_reference: customerDetails.reference || null,
                customer_phone: customerDetails.phone || null,
                status: 'pendiente'
            };
            const { error } = await _supabase.from('orders').insert([orderData]);
            return { error };
        }

        function setCodFormLoading(isLoading) {
            codSubmitBtn.disabled = isLoading;
            codLoader.classList.toggle('hidden', !isLoading);
            codBtnText.textContent = isLoading ? 'Confirmando...' : 'Confirmar Pedido';
        }

        codForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setCodFormLoading(true);

            const total = cart.reduce((acc, item) => acc + item.price, 0);
            const customerDetails = {
                name: document.getElementById('cod-name').value,
                address: document.getElementById('cod-address').value,
                reference: document.getElementById('cod-reference').value,
                phone: document.getElementById('cod-phone').value
            };

            const { error } = await saveOrder('cod', total, cart, customerDetails);

            if (error) {
                codStatus.textContent = `Error al procesar el pedido: ${error.message}`;
                codStatus.className = 'status-message error';
                codStatus.classList.remove('hidden');
                setCodFormLoading(false);
            } else {
                codStatus.textContent = '¡Pedido realizado con éxito! Gracias por tu compra.';
                codStatus.className = 'status-message success';
                codStatus.classList.remove('hidden');
                cart = []; updateCartCount();
                setCodFormLoading(false);
                setTimeout(closeCodModal, 3000);
            }
        });

        // --- LÓGICA DE AUTENTICACIÓN (Login/Logout/Register) ---
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showLogin = document.getElementById('show-login');
        const showRegister = document.getElementById('show-register');
        const loginStatus = document.getElementById('login-status');

        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden'); registerForm.classList.remove('hidden');
            loginStatus.textContent = ''; loginStatus.classList.add('hidden');
        });
        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.remove('hidden'); registerForm.classList.add('hidden');
            loginStatus.textContent = ''; loginStatus.classList.add('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginStatus.textContent = ''; loginStatus.classList.add('hidden');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) {
                loginStatus.textContent = 'Error: Email o contraseña incorrectos.';
                loginStatus.className = 'status-message error';
                loginStatus.classList.remove('hidden');
            } else {
                window.location.hash = '#admin';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginStatus.textContent = 'Registrando...';
            loginStatus.className = 'status-message';
            loginStatus.classList.remove('hidden');
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const { data, error } = await _supabase.auth.signUp({ email, password });
            if (error) {
                loginStatus.textContent = `Error: ${error.message}`;
                loginStatus.className = 'status-message error';
            } else {
                loginStatus.textContent = '¡Registro exitoso! Revisa tu email para confirmar tu cuenta.';
                loginStatus.className = 'status-message success';
                registerForm.reset();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await _supabase.auth.signOut();
            window.location.hash = '#shop';
        });
        
        
        // --- LÓGICA DEL MODAL DE IMAGEN ---
        const imageModalOverlay = document.getElementById('image-modal-overlay');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const closeImageModalBtn = document.getElementById('close-image-modal-btn');
        
        function openImageModal(imageUrl, altText) {
            modalImage.src = imageUrl;
            modalImage.alt = altText;
            imageModalOverlay.classList.remove('hidden');
            imageModal.classList.remove('hidden'); 
            imageModalOverlay.classList.add('visible');
            imageModal.classList.add('visible'); 
        }
        
        function closeImageModal() {
            imageModalOverlay.classList.remove('visible');
            imageModal.classList.remove('visible');
            imageModalOverlay.classList.add('hidden');
            imageModal.classList.add('hidden');
            modalImage.src = ""; 
            modalImage.alt = "";
        }
        
        closeImageModalBtn.addEventListener('click', closeImageModal);
        imageModalOverlay.addEventListener('click', closeImageModal); 
        

        // --- LÓGICA DEL PANEL DE ADMIN ---

        // Cargar Nuevo Producto
        const productForm = document.getElementById('product-form');
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                const name = document.getElementById('product-name').value;
                const price = parseFloat(document.getElementById('product-price').value);
                const category = document.getElementById('product-category').value;
                const imageFile = document.getElementById('product-image').files[0];

                if (!name || !price || !category || !imageFile) throw new Error('Completa todos los campos, incluida la categoría.');

                const fileName = `${Date.now()}-${imageFile.name}`;
                const { error: uploadError } = await _supabase.storage.from('product-images').upload(fileName, imageFile);
                if (uploadError) throw uploadError;

                const { data: urlData } = _supabase.storage.from('product-images').getPublicUrl(fileName);

                const { error: insertError } = await _supabase.from('products').insert([{ name, price, image_url: urlData.publicUrl, category }]);
                if (insertError) throw insertError;

                showStatus('¡Producto guardado con éxito!', 'success');
                productForm.reset();
                document.getElementById('file-name').textContent = 'Ningún archivo seleccionado';
                productsLoaded = false;
                loadAdminProducts();
            } catch (error) {
                console.error('Error:', error.message);
                showStatus(error.message, 'error');
            } finally {
                setLoading(false);
            }
        });

        document.getElementById('product-image').addEventListener('change', () => {
            const fileInput = document.getElementById('product-image');
            document.getElementById('file-name').textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Ningún archivo seleccionado';
        });

        function setLoading(isLoading) {
            document.getElementById('submit-btn').disabled = isLoading;
            document.getElementById('loader').classList.toggle('hidden', !isLoading);
            document.getElementById('btn-text').textContent = isLoading ? 'Guardando...' : 'Guardar Producto';
        }
        function showStatus(message, type) {
            const adminStatus = document.getElementById('admin-status');
            adminStatus.textContent = message;
            adminStatus.className = `status-message ${type}`;
        }
        
        // --- LÓGICA DE UPLOAD DE LOGO ---
        const logoForm = document.getElementById('logo-upload-form');
        const logoFileInput = document.getElementById('logo-image');
        const logoFileName = document.getElementById('logo-file-name');
        const logoSubmitBtn = document.getElementById('logo-submit-btn');
        const logoLoader = document.getElementById('logo-loader');
        const logoBtnText = document.getElementById('logo-btn-text');
        const logoStatus = document.getElementById('logo-status');

        logoFileInput.addEventListener('change', () => {
            logoFileName.textContent = logoFileInput.files.length > 0 ? logoFileInput.files[0].name : 'Ningún archivo seleccionado';
        });

        function setLogoLoading(isLoading) {
            logoSubmitBtn.disabled = isLoading;
            logoLoader.classList.toggle('hidden', !isLoading);
            logoBtnText.textContent = isLoading ? 'Guardando...' : 'Guardar Logo';
        }

        logoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageFile = logoFileInput.files[0];
            if (!imageFile) {
                logoStatus.textContent = 'Por favor, selecciona un archivo.';
                logoStatus.className = 'status-message error';
                logoStatus.classList.remove('hidden');
                return;
            }
            setLogoLoading(true);
            logoStatus.classList.add('hidden');

            try {
                const fileName = `logo/store-logo-${Date.now()}`;
                const { error: uploadError } = await _supabase.storage
                    .from('product-images')
                    .upload(fileName, imageFile, {
                         cacheControl: '3600',
                         upsert: false 
                    });
                if (uploadError) throw uploadError;

                const { data: urlData } = _supabase.storage
                    .from('product-images')
                    .getPublicUrl(fileName);
                const newLogoUrl = urlData.publicUrl;

                const { data: oldData, error: fetchError } = await _supabase
                    .from('store_settings')
                    .select('value')
                    .eq('setting_name', 'logo_url')
                    .single();
                
                if (oldData && oldData.value) {
                    const oldFileName = oldData.value.split('product-images/')[1];
                    if (oldFileName) {
                        await _supabase.storage.from('product-images').remove([oldFileName]);
                    }
                }

                const { error: upsertError } = await _supabase
                    .from('store_settings')
                    .upsert({ setting_name: 'logo_url', value: newLogoUrl });
                
                if (upsertError) throw upsertError;

                logoStatus.textContent = '¡Logo actualizado con éxito!';
                logoStatus.className = 'status-message success';
                logoStatus.classList.remove('hidden');
                logoForm.reset();
                logoFileName.textContent = 'Ningún archivo seleccionado';

                document.getElementById('store-logo-img').src = newLogoUrl;
                document.getElementById('store-logo-img').style.display = 'block';

            } catch (error) {
                console.error('Error al subir logo:', error.message);
                logoStatus.textContent = `Error: ${error.message}`;
                logoStatus.className = 'status-message error';
                logoStatus.classList.remove('hidden');
            } finally {
                setLogoLoading(false);
            }
        });

        
        // --- LÓGICA DE INFO DE CONTACTO Y DIRECCIÓN ---
        const infoForm = document.getElementById('info-form');
        const infoSubmitBtn = document.getElementById('info-submit-btn');
        const infoLoader = document.getElementById('info-loader');
        const infoBtnText = document.getElementById('info-btn-text');
        const infoStatus = document.getElementById('info-status');
        const adminContactInput = document.getElementById('admin-contact-info');
        const adminAddressInput = document.getElementById('admin-address-info');
        const adminMapInput = document.getElementById('admin-map-src'); 
        
        function setInfoLoading(isLoading) {
            infoSubmitBtn.disabled = isLoading;
            infoLoader.classList.toggle('hidden', !isLoading);
            infoBtnText.textContent = isLoading ? 'Guardando...' : 'Guardar Información';
        }
        
        infoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setInfoLoading(true);
            infoStatus.classList.add('hidden');
            
            const contactValue = adminContactInput.value;
            const addressValue = adminAddressInput.value;
            const mapValue = adminMapInput.value; 

            try {
                // MODIFICADO: Añadir 'map_embed_src' al upsert
                const { error } = await _supabase.from('store_settings').upsert([
                    { setting_name: 'contact_info', value: contactValue },
                    { setting_name: 'address_info', value: addressValue },
                    { setting_name: 'map_embed_src', value: mapValue } 
                ]);

                if (error) throw error;
                
                infoStatus.textContent = '¡Información guardada con éxito!';
                infoStatus.className = 'status-message success';
                infoStatus.classList.remove('hidden');
                
                // Actualizar el footer y mapa en vivo
                document.getElementById('footer-contact').textContent = contactValue || 'Añade info de contacto';
                document.getElementById('footer-address').textContent = addressValue || 'Añade una dirección';
                displayMap(mapValue); 

            } catch (error) {
                console.error('Error al guardar información:', error.message);
                infoStatus.textContent = `Error: ${error.message}`;
                infoStatus.className = 'status-message error';
                infoStatus.classList.remove('hidden');
            } finally {
                setInfoLoading(false);
            }
        });


        // --- GESTIÓN DE PEDIDOS (Admin) ---
        const ordersListDiv = document.getElementById('orders-list');
        const loadingOrdersMsg = document.getElementById('loading-orders-message');

        async function loadOrders() {
            loadingOrdersMsg.textContent = 'Cargando pedidos...';
            loadingOrdersMsg.style.display = 'block';
            ordersListDiv.innerHTML = '';
            try {
                const { data, error } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                if (data.length === 0) {
                    loadingOrdersMsg.textContent = 'No se han recibido pedidos todavía.'; return;
                }
                loadingOrdersMsg.style.display = 'none';

                data.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'order-card';
                    const orderDate = new Date(order.created_at).toLocaleString('es-ES');
                    const itemsHtml = order.items.map(item =>
                        `<li>
                           ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" style="width: 30px; height: 30px; object-fit: cover; margin-right: 10px; border-radius: 4px;">` : ''}
                           <span>${item.name}</span>
                           <span>$${item.price.toFixed(2)}</span>
                         </li>`
                    ).join('');

                    let customerHtml = '';
                    if (order.customer_name) {
                        customerHtml = `
                            <hr style="margin: 1rem 0; border-color: var(--color-border);">
                            <p><strong>Cliente:</strong> ${order.customer_name}</p>
                            <p><strong>Dirección:</strong> ${order.customer_address}</p>
                        `;
                        if (order.customer_reference) {
                            customerHtml += `<p><strong>Referencia:</strong> ${order.customer_reference}</p>`;
                        }
                        customerHtml += `<p><strong>Teléfono:</strong> ${order.customer_phone}</p>`;
                    }

                    const isEnviado = order.status === 'enviado';

                    orderCard.innerHTML = `
                        <div class="order-header">
                            <p><strong>Fecha:</strong> ${orderDate}</p>
                            <p><strong>Método:</strong> ${order.payment_method.toUpperCase()}</p>
                            <p><strong>Estado:</strong> <span class="order-status ${order.status}">${order.status}</span></p>
                            <p class="order-total">Total: $${parseFloat(order.total_amount).toFixed(2)}</p>
                        </div>
                        <h4>Productos:</h4>
                        <ul class="order-items-list">${itemsHtml}</ul>
                        ${customerHtml}
                        <div class="order-actions">
                            <button class="btn-mark-sent" data-id="${order.id}" ${isEnviado ? 'disabled' : ''}>
                                ${isEnviado ? '✓ Enviado' : 'Marcar como Enviado'}
                            </button>
                            <button class="btn-delete-order" data-id="${order.id}">
                                Eliminar Pedido
                            </button>
                        </div>
                    `;
                    ordersListDiv.appendChild(orderCard);
                });
            } catch (error) {
                console.error('Error al cargar pedidos:', error.message);
                loadingOrdersMsg.textContent = `Error al cargar pedidos: ${error.message}`;
            }
        }

        async function updateOrderStatus(id, newStatus) {
            try {
                const { error } = await _supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', id);
                if (error) throw error;
                loadOrders();
            } catch (error) {
                console.error('Error al actualizar estado del pedido:', error.message);
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteOrder(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este pedido? Esta acción es permanente.')) {
                return;
            }
            try {
                const { error } = await _supabase
                    .from('orders')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                loadOrders();
            } catch (error) {
                console.error('Error al eliminar pedido:', error.message);
                alert(`Error: ${error.message}`);
            }
        }

        // --- GESTIÓN DE PRODUCTOS (Admin) ---
        const adminProductsList = document.getElementById('admin-products-list');
        const loadingAdminProductsMsg = document.getElementById('loading-admin-products-message');
        const adminProductsStatus = document.getElementById('admin-products-status');
        const editModal = document.getElementById('edit-product-modal');
        const editOverlay = document.getElementById('edit-product-overlay');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editForm = document.getElementById('edit-product-form');
        const editSubmitBtn = document.getElementById('edit-submit-btn');
        const editLoader = document.getElementById('edit-loader');
        const editBtnText = document.getElementById('edit-btn-text');
        const editFileInput = document.getElementById('edit-product-image');
        const editFileNameDiv = document.getElementById('edit-file-name');

        async function loadAdminProducts() {
            loadingAdminProductsMsg.textContent = 'Cargando productos...';
            loadingAdminProductsMsg.style.display = 'block';
            adminProductsStatus.classList.add('hidden');
            adminProductsList.innerHTML = '';

            try {
                const { data, error } = await _supabase.from('products').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                if (data.length === 0) {
                    loadingAdminProductsMsg.textContent = 'No has subido ningún producto.'; return;
                }
                loadingAdminProductsMsg.style.display = 'none';

                data.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'admin-product-card';
                    card.innerHTML = `
                        <img src="${product.image_url}" alt="${product.name}">
                        <div class="admin-product-info">
                            <h4>${product.name}</h4>
                            <p>$${parseFloat(product.price).toFixed(2)}</p>
                            <p class="admin-product-category">${product.category || 'Sin categoría'}</p>
                        </div>
                        <div class="admin-product-actions">
                            <button class="btn-edit"
                                data-id="${product.id}"
                                data-name="${escapeHTML(product.name)}"
                                data-price="${product.price}"
                                data-image-url="${product.image_url}"
                                data-category="${product.category}">Editar</button>
                            <button class="btn-delete" data-id="${product.id}" data-image-url="${product.image_url}">Eliminar</button>
                        </div>
                    `;
                    adminProductsList.appendChild(card);
                });
            } catch (error) {
                console.error('Error al cargar productos (admin):', error.message);
                loadingAdminProductsMsg.textContent = `Error al cargar productos: ${error.message}`;
            }
        }

        function openEditModal(id, name, price, imageUrl, category) {
            decoder.innerHTML = name;
            document.getElementById('edit-product-id').value = id;
            document.getElementById('edit-product-name').value = decoder.value;
            document.getElementById('edit-product-price').value = price;
            document.getElementById('edit-old-image-url').value = imageUrl;
            document.getElementById('edit-product-category').value = category || '';

            editFileInput.value = '';
            editFileNameDiv.textContent = 'Ningún archivo nuevo';
            editOverlay.classList.remove('hidden'); editModal.classList.remove('hidden');
            editOverlay.classList.add('visible'); editModal.classList.add('visible');
        }
        function closeEditModal() {
            editOverlay.classList.remove('visible'); editModal.classList.remove('visible');
            editOverlay.classList.add('hidden'); editModal.classList.add('hidden');
        }

        closeEditModalBtn.addEventListener('click', closeEditModal);
        editOverlay.addEventListener('click', closeEditModal);

        editFileInput.addEventListener('change', () => {
            editFileNameDiv.textContent = editFileInput.files.length > 0 ? editFileInput.files[0].name : 'Ningún archivo nuevo';
        });

        function setEditFormLoading(isLoading) {
            editSubmitBtn.disabled = isLoading;
            editLoader.classList.toggle('hidden', !isLoading);
            editBtnText.textContent = isLoading ? 'Guardando...' : 'Guardar Cambios';
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setEditFormLoading(true);

            const id = document.getElementById('edit-product-id').value;
            const oldImageUrl = document.getElementById('edit-old-image-url').value;
            const newImageFile = editFileInput.files[0];
            const updateData = {
                name: document.getElementById('edit-product-name').value,
                price: parseFloat(document.getElementById('edit-product-price').value),
                category: document.getElementById('edit-product-category').value
            };

            if (!updateData.category) {
                 document.getElementById('edit-product-status').textContent = `Error: Debes seleccionar una categoría.`;
                document.getElementById('edit-product-status').className = 'status-message error';
                setEditFormLoading(false);
                return;
            }

            try {
                if (newImageFile) {
                    const newFileName = `${Date.now()}-${newImageFile.name}`;
                    const { error: uploadError } = await _supabase.storage.from('product-images').upload(newFileName, newImageFile);
                    if (uploadError) throw uploadError;

                    const { data: urlData } = _supabase.storage.from('product-images').getPublicUrl(newFileName);
                    updateData.image_url = urlData.publicUrl;
                }

                const { error: updateError } = await _supabase.from('products').update(updateData).eq('id', id);
                if (updateError) throw updateError;

                if (newImageFile && updateData.image_url !== oldImageUrl) {
                    const oldFileName = oldImageUrl.split('product-images/')[1];
                    if (oldFileName) {
                       await _supabase.storage.from('product-images').remove([oldFileName]);
                    }
                }

                productsLoaded = false;
                loadAdminProducts();
                closeEditModal();

            } catch (error) {
                console.error('Error al actualizar producto:', error.message);
                document.getElementById('edit-product-status').textContent = `Error: ${error.message}`;
                document.getElementById('edit-product-status').className = 'status-message error';
            } finally {
                setEditFormLoading(false);
            }
        });

        async function deleteProduct(id, imageUrl) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.')) {
                return;
            }
            try {
                const { error: dbError } = await _supabase.from('products').delete().eq('id', id);
                if (dbError) throw dbError;

                const fileName = imageUrl.split('product-images/')[1];
                if (fileName) {
                   await _supabase.storage.from('product-images').remove([fileName]);
                }

                adminProductsStatus.textContent = 'Producto eliminado con éxito.';
                adminProductsStatus.className = 'status-message success';
                adminProductsStatus.classList.remove('hidden');

                productsLoaded = false;
                loadAdminProducts();

            } catch (error) {
                console.error('Error al eliminar producto:', error.message);
                adminProductsStatus.textContent = `Error: ${error.message}`;
                adminProductsStatus.className = 'status-message error';
                adminProductsStatus.classList.remove('hidden');
            }
        }

        // --- LISTENER DE CLIC GLOBAL ---
        document.addEventListener('click', (e) => {
            // Clic en imagen de producto en la tienda
            const productImage = e.target.closest('.product-image-clickable');
            if (productImage) {
                openImageModal(productImage.src, productImage.alt);
                return; 
            }
            
            // Resto de los listeners...
            const cartButton = e.target.closest('.cart-btn');
            if (cartButton && cartButton.id !== 'checkout-btn') {
                addToCart(cartButton.dataset.id, cartButton.dataset.name, cartButton.dataset.price, cartButton.dataset.imageUrl);
                return;
            }
            const editButton = e.target.closest('.btn-edit');
            if (editButton) {
                const ds = editButton.dataset;
                openEditModal(ds.id, ds.name, ds.price, ds.imageUrl, ds.category);
                return;
            }
            const deleteButton = e.target.closest('.btn-delete');
            if (deleteButton) {
                deleteProduct(deleteButton.dataset.id, deleteButton.dataset.imageUrl);
                return;
            }
            const markSentButton = e.target.closest('.btn-mark-sent');
            if (markSentButton) {
                updateOrderStatus(markSentButton.dataset.id, 'enviado');
                return;
            }
            const deleteOrderButton = e.target.closest('.btn-delete-order');
            if (deleteOrderButton) {
                deleteOrder(deleteOrderButton.dataset.id);
                return;
            }
        });
        
        // --- Función para mostrar el mapa ---
        function displayMap(srcUrl) {
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) return;

            mapContainer.innerHTML = ''; // Limpiar mapa anterior
            if (srcUrl) {
                const iframe = document.createElement('iframe');
                iframe.src = srcUrl;
                iframe.width = "100%";
                iframe.height = "400";
                iframe.style.border = 0;
                iframe.allowFullscreen = true;
                iframe.loading = "lazy";
                iframe.referrerPolicy = "no-referrer-when-downgrade";
                mapContainer.appendChild(iframe);
            }
        }


        // --- Cargar toda la info de la tienda ---
        async function loadStoreInfo() {
            // Elementos del footer
            const logoImg = document.getElementById('store-logo-img');
            const footerContact = document.getElementById('footer-contact');
            const footerAddress = document.getElementById('footer-address');
            
            // Elementos del formulario Admin (pueden no existir si no está logueado)
            const adminContact = document.getElementById('admin-contact-info');
            const adminAddress = document.getElementById('admin-address-info');
            const adminMap = document.getElementById('admin-map-src'); 

            try {
                // Pedir todas las filas de la tabla de configuración
                const { data, error } = await _supabase
                    .from('store_settings')
                    .select('*'); 
                
                if (error) throw error;
                if (!data) return;

                // Valores por defecto
                let logoUrl = null;
                let contactInfo = 'Añade info de contacto';
                let addressInfo = 'Añade una dirección';
                let mapSrc = null; 

                // Buscar cada valor en los resultados
                data.forEach(setting => {
                    if (setting.setting_name === 'logo_url' && setting.value) {
                        logoUrl = setting.value;
                    }
                    if (setting.setting_name === 'contact_info' && setting.value) {
                        contactInfo = setting.value;
                    }
                    if (setting.setting_name === 'address_info' && setting.value) {
                        addressInfo = setting.value;
                    }
                    if (setting.setting_name === 'map_embed_src' && setting.value) { 
                        mapSrc = setting.value;
                    }
                });

                // --- Aplicar a elementos PÚBLICOS (Footer y Nav) ---
                if (logoUrl) {
                    logoImg.src = logoUrl;
                    logoImg.style.display = 'block'; 
                }
                footerContact.textContent = contactInfo;
                footerAddress.textContent = addressInfo;
                displayMap(mapSrc); // Cargar el mapa

                // --- Aplicar a elementos de ADMIN (Inputs del formulario) ---
                // Comprobar si existen antes de asignar (por si no está en #admin)
                if (adminContact) {
                    adminContact.value = (contactInfo === 'Añade info de contacto') ? '' : contactInfo;
                }
                if (adminAddress) {
                    adminAddress.value = (addressInfo === 'Añade una dirección') ? '' : addressInfo;
                }
                if (adminMap) { 
                    adminMap.value = mapSrc || '';
                }

            } catch (error) {
                console.error('Error al cargar la información de la tienda:', error.message);
                footerContact.textContent = 'Error al cargar info.';
                footerAddress.textContent = 'Error al cargar info.';
            }
        }


        // --- INICIALIZACIÓN ---
        window.addEventListener('hashchange', handleRouting);

        document.addEventListener('DOMContentLoaded', () => {
            handleRouting(); // Cargar la ruta inicial
            loadStoreInfo(); // Carga Logo, Contacto, Dirección y Mapa

            const loginLink = document.getElementById('login-nav-link');
            const adminLink = document.getElementById('admin-nav-link');

            // Controlar visibilidad de enlaces de Login/Admin
            _supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    loginLink.classList.add('hidden');
                    adminLink.classList.remove('hidden');
                } else {
                    loginLink.classList.remove('hidden');
                    adminLink.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
